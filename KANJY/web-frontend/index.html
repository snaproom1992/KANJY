<!DOCTYPE html>
<html lang="ja" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日程調整 - KANJY</title>

    <!-- キャッシュ制御メタタグ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Open Graph Tags -->
    <meta property="og:title" content="日程調整 - KANJY">
    <meta property="og:description" content="飲み会の日程調整をかんたんに。">
    <meta property="og:url" content="https://kanjy.vercel.app/">
    <meta property="og:image" content="https://kanjy.vercel.app/assets/og-image.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="KANJY">

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="日程調整 - KANJY">
    <meta name="twitter:description" content="飲み会の日程調整をかんたんに。">
    <meta name="twitter:image" content="https://kanjy.vercel.app/assets/og-image.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- カスタムスタイル -->
    <style>
        /* 基本的なリセット */
        * {
            box-sizing: border-box;
        }

        /* 横スクロール制御 */
        body,
        html {
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* テーブルコンテナは横スクロール許可 */
        .overflow-x-auto {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }


        /* テーブル行のホバー効果 */
        tbody tr:hover,
        .table-row:hover,
        tr:hover {
            background: rgba(248, 250, 252, 0.7) !important;
            transform: translateX(2px) !important;
        }

        /* Notion風タイポグラフィーシステム */
        .notion-heading-1 {
            font-size: 2.5rem;
            line-height: 1.2;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #111827;
        }

        .notion-heading-2 {
            font-size: 2rem;
            line-height: 1.3;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: #111827;
        }

        .notion-heading-3 {
            font-size: 1.5rem;
            line-height: 1.4;
            font-weight: 600;
            letter-spacing: -0.005em;
            color: #111827;
        }

        .notion-heading-4 {
            font-size: 1.25rem;
            line-height: 1.5;
            font-weight: 600;
            color: #374151;
        }

        .notion-body {
            font-size: 1rem;
            line-height: 1.6;
            font-weight: 400;
            color: #4B5563;
        }

        .notion-body-medium {
            font-size: 1rem;
            line-height: 1.6;
            font-weight: 500;
            color: #374151;
        }

        .notion-caption {
            font-size: 0.875rem;
            line-height: 1.5;
            font-weight: 400;
            color: #6B7280;
        }

        .notion-small {
            font-size: 0.75rem;
            line-height: 1.4;
            font-weight: 500;
            color: #9CA3AF;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .notion-mono {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            font-weight: 400;
            color: #374151;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        kanjy: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#000000',
                            600: '#374151',
                            700: '#1f2937',
                            800: '#111827',
                            900: '#030712',
                        },
                        // SwiftUIカラーパレット（洗練版）
                        attending: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            500: '#10b981', // 美しい緑
                            600: '#059669',
                            700: '#047857',
                        },
                        maybe: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            500: '#f97316', // 鮮やかなオレンジ
                            600: '#ea580c',
                            700: '#c2410c',
                        },
                        notAttending: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444', // 洗練された赤
                            600: '#dc2626',
                            700: '#b91c1c',
                        },
                        undecided: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            500: '#6b7280', // 上品なグレー
                            600: '#4b5563',
                            700: '#374151',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'float': 'float 3s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'bounce-gentle': 'bounceGentle 2s infinite',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' },
                        },
                        bounceGentle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        }
                    },
                    backdropBlur: {
                        '3xl': '64px',
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
                        'elegant': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'soft': '0 2px 15px 0 rgba(0, 0, 0, 0.1)',
                        'floating': '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS変数 */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --card-background: #ffffff;
            --card-border: #E9E5E0;
            --card-shadow-soft: 0 1px 3px rgba(15, 23, 42, 0.08);
            --card-shadow-hover: 0 12px 35px rgba(15, 23, 42, 0.14);
            --card-shadow-strong: 0 20px 45px rgba(15, 23, 42, 0.2);
            --section-divider: #E9E5E0;
            --bg-hover: rgba(248, 250, 252, 0.7);
            /* 新しいホバー背景色変数 */
        }

        @keyframes gradient-shift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .gradient-animated {
            background: #ffffff;
        }

        .glassmorphism {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .table-hover-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .status-pill {
            position: relative;
            overflow: hidden;
        }

        .status-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .status-pill:hover::before {
            left: 100%;
        }

        .floating-element {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-element:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px var(--shadow-color);
        }

        .smooth-reveal {
            animation: fadeIn 0.8s ease-out;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0056cc, #4c46a6);
        }

        /* 高度なマイクロインタラクション */
        .micro-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ボタンホバー効果の強化 */
        .interactive-element {
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
            will-change: transform, box-shadow;
        }

        .interactive-element::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .interactive-element:hover::before {
            left: 100%;
        }

        .interactive-element:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .interactive-element:active {
            transform: translateY(0) scale(0.98);
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notion-section {
            background: var(--card-background);
            border-top: 1px solid var(--section-divider);
            border-bottom: 1px solid var(--section-divider);
        }

        .card-divider {
            border-bottom: 1px solid var(--section-divider);
        }

        .enhanced-card {
            background: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            box-shadow: var(--card-shadow-soft);
        }

        /* ホバー効果（タッチデバイスでは無効化してSticky Hoverを防止） */
        @media (hover: hover) {
            .card-hover {
                transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }

            .table-row {
                transition: background-color 0.15s ease;
            }

            .table-row:hover {
                background-color: var(--bg-hover);
            }
        }

        /* タッチデバイス用のアクティブ状態 */
        .card-hover:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        .notion-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .notion-table thead th {
            background: #F7F6F3;
        }

        .notion-table thead tr {
            border-bottom: 1px solid var(--section-divider);
        }

        .notion-table thead th+th,
        .notion-table tbody td+td {
            border-left: 1px solid var(--section-divider);
        }

        .notion-table thead th:first-child,
        .notion-table tbody td:first-child {
            border-left: none;
        }

        .stat-icon--attending {
            color: #0F7B0F;
        }

        .stat-icon--maybe {
            color: #D97706;
        }

        .stat-icon--decline {
            color: #6B7280;
        }

        /* テーブル行のホバー効果強化 */
        .table-row {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .table-row:hover {
            background: rgba(248, 250, 252, 0.7) !important;
            transform: translateX(2px) !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* ステータスバッジの改善 */
        .status-badge {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .status-badge:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* パルス効果 */
        .pulse-effect {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        /* ローディング効果の改善 */
        .loading-shimmer {
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* カードの改善されたホバー効果 */
        .enhanced-card {
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            box-shadow: var(--card-shadow-soft);
        }

        /* スクロール時の要素表示アニメーション */
        .fade-in-up {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in-up.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* モバイル最適化 */
        @media (max-width: 768px) {

            /* ナビゲーションの改善 */
            .max-w-7xl,
            .max-w-4xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* ヘッダースタイルは shared-header.js で統一管理 */

            /* タイトルのフォントサイズ調整 */
            .notion-heading-1 {
                font-size: 1.875rem;
                line-height: 1.2;
            }

            .notion-heading-2 {
                font-size: 1.5rem;
                line-height: 1.3;
            }

            .notion-heading-4 {
                font-size: 1.125rem;
                line-height: 1.4;
            }

            /* グラフ/表切り替えボタンの最適化 */
            #chart-view-btn span,
            #table-view-btn span {
                display: none;
            }

            #chart-view-btn,
            #table-view-btn {
                padding: 0.5rem !important;
                min-width: 40px;
            }

            /* グラフ表示エリアの高さ調整 */
            #schedule-chart {
                height: 300px !important;
            }

            /* タッチフレンドリーなボタン */
            .interactive-element {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            /* テーブルの改善 */
            .table-row:hover {
                transform: none;
                background: rgba(248, 250, 252, 0.7);
            }

            /* ステータスバッジのタッチ対応 */
            .status-badge {
                min-width: 44px;
                min-height: 44px;
                padding: 0.5rem;
            }

            .status-badge:hover {
                transform: scale(1.05);
                rotate: 0deg;
            }

            /* カードのモバイル表示 */
            .enhanced-card {
                margin: 0.75rem 0 !important;
                border-radius: 1rem;
                padding: 1.25rem !important;
            }

            .card-hover:hover {
                transform: translateY(-2px) scale(1.005);
            }

            /* カード内のセクション余白削減 */
            .card-section {
                padding: 1rem !important;
            }

            /* カードヘッダーのコンパクト化 */
            .card-header {
                margin-bottom: 0.75rem !important;
            }

            /* フォントサイズの調整 */
            .text-3xl {
                font-size: 1.875rem;
            }

            .text-2xl {
                font-size: 1.5rem;
            }

            /* スペーシングの調整 */
            .px-8 {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .py-6 {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

            /* テーブルスクロールの改善 */
            .overflow-x-auto {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .overflow-x-auto::-webkit-scrollbar {
                height: 4px;
            }

            .overflow-x-auto::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 2px;
            }

            /* テーブルの最小幅設定 */
            .notion-table {
                min-width: 600px;
            }

            /* セクションの余白調整 */
            .notion-section {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

            /* ボタングループのスペース調整 */
            button+button {
                margin-left: 0.5rem;
            }

            /* 回答一覧テーブルのモバイル最適化 */
            .responses-table-container {
                padding: 0 1rem;
            }

            .responses-table {
                overflow-x: visible !important;
            }

            .responses-table table {
                display: block;
                width: 100% !important;
                table-layout: auto;
            }

            .responses-table thead {
                display: none;
                /* モバイルではヘッダーを非表示 */
            }

            .responses-table tbody {
                display: block;
            }

            .responses-table tbody tr {
                display: block;
                margin-bottom: 1rem;
                padding: 1.25rem;
                background: white;
                border: 1px solid #E5E7EB;
                border-radius: 0.75rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                transition: all 0.2s ease;
            }

            .responses-table tbody tr:hover {
                background: #F9FAFB !important;
                transform: none !important;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08) !important;
            }

            .responses-table tbody td {
                display: block;
                padding: 0.5rem 0 !important;
                border: none !important;
                text-align: left !important;
            }

            /* 参加者名のスタイル */
            .responses-table tbody td:first-child {
                font-size: 1.125rem;
                font-weight: 600;
                color: #1F2937;
                padding-bottom: 0.75rem !important;
                margin-bottom: 0.75rem;
                border-bottom: 1px solid #E5E7EB !important;
                cursor: pointer !important;
            }

            .responses-table tbody td:first-child>* {
                pointer-events: auto !important;
                cursor: pointer !important;
            }

            /* 日程回答のスタイル */
            .responses-table tbody td:not(:first-child) {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                padding: 0.625rem 0 !important;
            }

            /* 日程情報の前にラベルを追加 */
            .responses-table tbody td:not(:first-child)::before {
                content: attr(data-date);
                font-weight: 500;
                color: #6B7280;
                font-size: 0.875rem;
                flex-shrink: 0;
                margin-right: 1rem;
                max-width: 60%;
            }

            /* ステータスバッジのモバイル調整 */
            .responses-table tbody td:not(:first-child) .status-badge {
                margin-left: auto;
            }

            /* メインコンテナの余白調整 */
            main {
                padding-top: 0 !important;
                padding-bottom: 1rem !important;
            }

            /* 段落の余白削減 */
            .notion-caption {
                margin-top: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* テキストの行間調整 */
            p {
                line-height: 1.6;
                margin-bottom: 0.75rem;
            }

            /* 大きな余白を持つ要素の調整 */
            .space-y-8>*+* {
                margin-top: 1rem !important;
            }

            .space-y-6>*+* {
                margin-top: 0.75rem !important;
            }

            /* タイトルの余白調整 */
            .notion-heading-1 {
                margin-top: 0.5rem !important;
                margin-bottom: 1rem !important;
            }

            .notion-heading-2 {
                margin-top: 1rem !important;
                margin-bottom: 0.75rem !important;
            }

            /* イベント情報カードのコンパクト化 */
            #event-info {
                padding: 1rem !important;
            }

            #event-info .space-y-4>*+* {
                margin-top: 0.75rem !important;
            }
        }

        /* タブレット対応 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .card-hover:hover {
                transform: translateY(-6px) scale(1.008);
            }

            .table-row:hover {
                transform: translateX(2px);
            }
        }

        /* デスクトップでは通常のテーブル表示 */
        @media (min-width: 769px) {
            .responses-table-container {
                padding: 0;
            }

            .responses-table {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }

            .responses-table table {
                display: table;
                table-layout: fixed;
            }

            .responses-table thead {
                display: table-header-group;
            }

            .responses-table tbody {
                display: table-row-group;
            }

            .responses-table tbody tr {
                display: table-row;
                margin-bottom: 0;
                padding: 0;
                background: transparent;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }

            .responses-table tbody td {
                display: table-cell;
                padding: 1rem 0.75rem !important;
                border-right: 1px solid #E9E5E0 !important;
                text-align: center !important;
            }

            .responses-table tbody td:first-child {
                font-size: inherit;
                font-weight: inherit;
                color: inherit;
                padding: 1rem 1.5rem !important;
                margin-bottom: 0;
                border-bottom: none !important;
                text-align: left !important;
            }

            .responses-table tbody td:not(:first-child) {
                display: table-cell !important;
                justify-content: center;
                align-items: center;
                padding: 1rem 0.75rem !important;
            }

            .responses-table tbody td:not(:first-child)::before {
                content: none;
            }
        }

        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --text-primary: #ffffff;
                --text-secondary: #b0b0b0;
                --border-primary: #404040;
                --bg-hover: rgba(45, 45, 45, 0.7);
                /* ダークモードのホバー背景色 */
            }

            .bg-white {
                background-color: var(--bg-secondary);
                color: var(--text-primary);
            }

            .text-gray-900 {
                color: var(--text-primary);
            }

            .text-stone-600 {
                color: var(--text-secondary);
            }

            .border-stone-200\/60 {
                border-color: var(--border-primary);
            }
        }

        /* 高解像度ディスプレイ対応 */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {
            .enhanced-card {
                border-width: 0.5px;
            }

            .status-badge {
                border-width: 0.5px;
            }
        }

        /* アクセシビリティ改善 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .fade-in-up {
                opacity: 1;
                transform: none;
            }
        }

        /* フォーカス表示の改善 */
        .interactive-element:focus {
            outline: 2px solid #007AFF;
            outline-offset: 2px;
        }

        .status-badge:focus {
            outline: 2px solid #007AFF;
            outline-offset: 2px;
        }

        /* プリント対応 */
        @media print {

            .interactive-element,
            .status-badge {
                box-shadow: none;
                transform: none;
            }

            .enhanced-card {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }

        /* テーブルの境界線リセット */
        .schedule-table table,
        .schedule-table th,
        .schedule-table td,
        .responses-table table,
        .responses-table th,
        .responses-table td {
            border: none;
            outline: none;
        }

        .schedule-table thead tr,
        .responses-table thead tr {
            border-bottom: 1px solid #E9E5E0;
        }

        .schedule-table tbody tr:hover,
        .responses-table tbody tr:hover {
            border: none;
        }

        /* カードのベースライン */
        .enhanced-card {
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 0.75rem;
        }

        /* ヘッダーのnavスタイルは shared-header.js で統一管理 */

        /* 回答CTAの強調 */
        .response-cta {
            background: linear-gradient(135deg, #1f2937, #0f172a);
            color: #f8fafc;
            box-shadow: var(--card-shadow-strong);
        }

        .response-cta:hover,
        .response-cta:focus-within {
            background: linear-gradient(135deg, #1f2937, #0f172a);
            color: #f8fafc;
        }

        .response-cta .notion-heading-4,
        .response-cta .notion-body {
            color: inherit;
        }

        .response-cta .accent-bar {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.35), rgba(148, 163, 184, 0.4));
        }

        .response-cta button {
            background: #f8fafc;
            color: #0f172a;
        }

        .response-cta button:hover {
            background: #e2e8f0;
        }
    </style>
</head>

<body class="font-sans antialiased text-gray-900 min-h-screen bg-stone-50">

    <!-- 共有ヘッダーコンポーネント -->
    <header class="relative">
        <div id="kanjy-header"></div>
    </header>
    <script src="shared-header.js"></script>

    <!-- Main Content -->
    <main class="pb-24">
        <!-- 共有イベント情報コンポーネント -->
        <div id="kanjy-event-info"></div>
        <script src="shared-event-info.js"></script>

        <div class="max-w-4xl mx-auto px-6 sm:px-8 lg:px-12 space-y-12 mt-12">

            <!-- Response Form CTA -->
            <section class="mt-12">
                <div class="enhanced-card card-hover response-cta p-8">
                    <div class="flex items-center space-x-3 mb-4 text-left">
                        <div class="w-1 h-6 rounded-full accent-bar"></div>
                        <h2 class="notion-heading-4">まだ回答していない方へ</h2>
                    </div>
                    <p class="notion-body mb-3 text-left">
                        ぜひあなたの都合を教えてください
                    </p>

                    <div class="text-center">
                        <button id="go-to-response-form-btn"
                            class="interactive-element micro-transition inline-flex items-center px-6 py-3 bg-white hover:bg-slate-200 text-stone-900 font-semibold rounded-xl shadow-sm hover:shadow-md"
                            aria-label="回答フォームに移動して参加状況を入力する">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            回答フォームに入力
                        </button>
                    </div>
                </div>
            </section>

            <!-- Beautiful Schedule Table -->
            <section class="mt-12 animate-slide-up fade-in-up">
                <div class="enhanced-card card-hover overflow-hidden">
                    <div class="px-8 py-6 card-divider">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-1 h-6 bg-gradient-to-b from-gray-800 to-gray-900 rounded-full"></div>
                                <h2 class="notion-heading-4">
                                    日程別回答状況
                                </h2>
                            </div>
                            <!-- 表示切り替えボタン -->
                            <div class="flex bg-stone-100 rounded-lg p-1">
                                <button id="chart-view-btn"
                                    class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 bg-white shadow-sm text-stone-900 flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                        </path>
                                    </svg>
                                    <span>グラフ</span>
                                </button>
                                <button id="table-view-btn"
                                    class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-stone-600 hover:text-stone-900 flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                        </path>
                                    </svg>
                                    <span>表</span>
                                </button>
                            </div>
                        </div>
                        <p class="notion-caption text-stone-600 mt-1">各候補日時の参加者数と人気度を一覧で確認できます。グラフと表を切り替えできます。</p>
                    </div>

                    <!-- グラフ表示エリア -->
                    <div id="chart-container" class="p-8">
                        <canvas id="schedule-chart" class="w-full" style="height: 400px;"></canvas>
                    </div>

                    <!-- テーブル表示エリア -->
                    <div id="table-container" class="overflow-x-auto schedule-table hidden md:block"
                        style="display: none;">
                        <table class="w-full notion-table" role="table" aria-label="日程別回答状況一覧">
                            <thead>
                                <tr>
                                    <th class="text-left py-3 px-6 font-medium text-stone-700 text-sm" scope="col">
                                        <div class="flex flex-col items-start space-y-1">
                                            <span class="notion-body-medium text-stone-900">候補日時</span>
                                            <span class="notion-caption text-stone-500">開始〜終了</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-4 font-medium text-stone-700 text-sm" scope="col">
                                        <div class="flex flex-col items-center space-y-1">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-lg stat-icon--attending">○</span>
                                                <span class="notion-body-medium">参加</span>
                                            </div>
                                            <span class="notion-caption text-stone-500">出席予定</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-4 font-medium text-stone-700 text-sm">
                                        <div class="flex flex-col items-center space-y-1">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-lg stat-icon--maybe">?</span>
                                                <span class="notion-body-medium">未定</span>
                                            </div>
                                            <span class="notion-caption text-stone-500">検討中</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-4 font-medium text-stone-700 text-sm">
                                        <div class="flex flex-col items-center space-y-1">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-lg stat-icon--decline">×</span>
                                                <span class="notion-body-medium">不参加</span>
                                            </div>
                                            <span class="notion-caption text-stone-500">欠席予定</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-4 font-medium text-stone-700 text-sm">
                                        <div class="flex flex-col items-center space-y-1">
                                            <span class="notion-body-medium">合計</span>
                                            <span class="notion-caption text-stone-500">回答人数</span>
                                        </div>
                                    </th>
                                    <th class="text-center py-3 px-6 font-medium text-stone-700 text-sm">
                                        <div class="flex flex-col items-center space-y-1">
                                            <span class="notion-body-medium">評価</span>
                                            <span class="notion-caption text-stone-500">推奨度</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="">
                                <!-- 動的に生成される日程別参加状況がここに挿入されます -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Schedule List Container -->
                    <div id="mobile-schedule-list" class="block md:hidden space-y-4 px-4 pb-6 mt-6"
                        style="display: none;">
                        <!-- 動的に生成されるカード一覧がここに挿入されます -->
                    </div>
                </div>
            </section>

            <!-- Detailed Response Table -->
            <section class="mt-12 animate-fade-in fade-in-up">
                <div class="enhanced-card card-hover overflow-hidden">
                    <div class="px-8 py-6 card-divider">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-1 h-6 bg-gradient-to-b from-gray-700 to-gray-800 rounded-full"></div>
                            <h2 class="notion-heading-4">
                                回答一覧
                            </h2>
                        </div>
                        <p class="notion-caption text-stone-600">全参加者の詳細な回答状況を確認・編集できます（名前クリックで編集）</p>
                    </div>

                    <div class="responses-table-container hidden md:block">
                        <div class="overflow-x-auto responses-table">
                            <table class="w-full notion-table">
                                <thead>
                                    <tr>
                                        <th
                                            class="text-left py-6 px-8 font-semibold text-stone-700 text-sm w-80 shadow-sm border-r border-stone-100 z-10 bg-white">
                                            <span class="notion-body-medium">参加者</span>
                                            <span class="block notion-caption text-stone-500 mt-1">編集するには名前をタップ</span>
                                        </th>
                                        <!-- 日程ヘッダーは動的に生成されます -->

                                    </tr>
                                </thead>
                                <tbody class="">
                                    <!-- 動的に生成される回答一覧がここに挿入されます -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mobile Card View -->
                    <div id="mobile-response-list" class="block md:hidden space-y-4 px-4 pb-6 mt-6">
                        <!-- 動的に生成されるカード一覧がここに挿入されます -->
                    </div>

                    <!-- Show More Button -->
                    <div id="show-more-section"
                        class="px-8 py-4 bg-stone-50/30 border-t border-stone-200/60 text-center">
                        <button id="show-more-button"
                            class="inline-flex items-center px-4 py-2 bg-stone-100 hover:bg-stone-200 text-stone-700 font-medium rounded-lg transition-all duration-200 border border-stone-200"
                            onclick="showMoreResponses()">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                            <span id="show-more-text">残り15名の回答を表示</span>
                        </button>
                    </div>
                </div>
            </section>


            <!-- URL Share Section -->
            <section class="mt-12">
                <div class="enhanced-card card-hover p-6">
                    <h2 class="notion-heading-4 mb-4">このイベントのURL</h2>

                    <div class="flex items-center space-x-2 mb-2">
                        <input type="text" id="eventUrl" readonly
                            class="flex-1 bg-stone-50 border border-stone-200 text-stone-600 text-sm rounded-lg focus:ring-stone-500 focus:border-stone-500 block w-full p-2.5 font-mono"
                            value="読み込み中...">
                        <button id="copyUrlBtn" onclick="copyEventUrl()"
                            class="flex-shrink-0 bg-stone-900 hover:bg-stone-800 text-white font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center transition-all duration-200 shadow-sm whitespace-nowrap">
                            <svg id="copyIcon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <span id="copyText">コピー</span>
                        </button>
                    </div>

                    <p class="text-xs text-stone-500 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        URLをLINEやSlack等で共有してください。受け取った人は参加の回答ができます。
                    </p>
                </div>
            </section>
        </div>
    </main>

    <!-- Safe Area Spacer for bottom navigation on iPhone X+ -->
    <div style="height: env(safe-area-inset-bottom); background: transparent;"></div>

    <!-- Footer -->
    <footer class="mt-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="text-center">
                <!-- Logo and Title -->
                <div class="flex items-center justify-center space-x-3 mb-6">
                    <img src="assets/App icon.png" alt="KANJY" class="w-10 h-10 rounded-lg shadow-soft">
                    <span class="text-2xl font-thin text-gray-900 tracking-widest uppercase">K A N J Y</span>
                </div>

                <!-- Main Description -->
                <p class="text-lg text-gray-600 mb-6">
                    幹事さんの負担を減らし、参加者みんなが楽しめる飲み会を。
                </p>

                <!-- App Description -->
                <div class="max-w-2xl mx-auto mb-8">
                    <p class="text-gray-600 mb-4">
                        KANJYは、日程調整から割り勘まで幹事さんをサポートします。
                    </p>

                    <!-- App Store Link -->
                    <a href="https://apps.apple.com/jp/app/kanjy/id6746665673" target="_blank"
                        class="inline-flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 transition-colors duration-200 px-6 py-3 rounded-xl">
                        <svg class="w-6 h-6 text-gray-700" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                        </svg>
                        <span class="text-gray-700 font-medium">App Storeでダウンロード</span>
                    </a>
                </div>

                <!-- Copyright -->
                <div class="space-y-2">
                    <div class="flex items-center justify-center space-x-4 text-sm text-gray-500">
                        <span>Made by KANJY Team</span>
                        <span>•</span>
                        <span>© 2025 KANJY</span>
                    </div>
                    <!-- Contact Info -->
                    <div class="flex items-center justify-center text-xs text-gray-400">
                        <span>お問い合わせ: </span>
                        <a href="mailto:snaproom.info@gmail.com"
                            class="ml-1 hover:text-kanjy-500 transition-colors duration-200">
                            snaproom.info@gmail.com
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://jvluhjifihiuopqdwjll.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bHVoamlmaWhpdW9wcWR3amxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNTc5OTEsImV4cCI6MjA2NjczMzk5MX0.WDTzIs73X8NHGFcIYFk4CN-7dH5tQT5l0Bd2uY6H9lc';

        // Supabaseクライアント（初期化はDOMContentLoadedの後）
        // グローバルスコープで宣言を避けるため、varを使用
        var supabase;

        // グローバル変数
        let currentEvent = null;
        let currentEventId = null;
        let currentResponses = [];
        let isNavigating = false; // ナビゲーション中フラグ（重複防止）

        // 表示制限機能のための変数
        let displayLimit = 5; // 最初に表示する件数
        let showingAll = false; // 全件表示中かどうか

        // 「もっと表示」ボタンのクリック処理
        function showMoreResponses() {
            showingAll = true;
            displayResponses(currentResponses);
        }

        // Supabase接続とデータ確認
        async function debugSupabaseConnection() {
            try {
                console.log('🔍 Supabase接続確認開始');

                // 1. eventsテーブルの全件確認
                const { data: allEvents, error: eventsError } = await supabase
                    .from('events')
                    .select('*');

                console.log('📋 eventsテーブル全件:', { allEvents, eventsError });

                if (eventsError) {
                    console.error('❌ eventsテーブルアクセスエラー:', eventsError);
                } else {
                    console.log('✅ eventsテーブル件数:', allEvents?.length || 0);
                    if (allEvents && allEvents.length > 0) {
                        console.log('📄 最初のイベント:', allEvents[0]);
                    }
                }

                // 2. responsesテーブルの全件確認
                const { data: allResponses, error: responsesError } = await supabase
                    .from('responses')
                    .select('*');

                console.log('📋 responsesテーブル全件:', { allResponses, responsesError });

                if (responsesError) {
                    console.error('❌ responsesテーブルアクセスエラー:', responsesError);
                } else {
                    console.log('✅ responsesテーブル件数:', allResponses?.length || 0);
                    if (allResponses && allResponses.length > 0) {
                        console.log('📄 最初の回答:', allResponses[0]);
                    }
                }

                // 3. 現在のイベントIDが存在するかチェック
                if (currentEventId) {
                    const { data: targetEvent, error: targetError } = await supabase
                        .from('events')
                        .select('*')
                        .eq('id', currentEventId);

                    console.log('🎯 対象イベント確認:', { targetEvent, targetError, eventId: currentEventId });
                }

            } catch (error) {
                console.error('❌ Supabase接続確認エラー:', error);
            }
        }

        // グラフ変数
        let scheduleChart = null;

        // 日程別回答状況グラフを作成
        function createScheduleChart(responses) {
            const canvas = document.getElementById('schedule-chart');
            if (!canvas || !currentEvent) {
                console.warn('⚠️ グラフ作成をスキップ: canvas または currentEvent が見つかりません');
                return;
            }

            // Chart.jsの読み込み確認
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.jsが読み込まれていません');
                return;
            }

            // データの構造をデバッグ
            console.log('🔍 グラフ作成開始');
            console.log('🔍 responses:', responses);
            console.log('🔍 currentEvent:', currentEvent);
            console.log('🔍 candidate_dates:', currentEvent.candidate_dates);

            // 回答データの構造を確認
            if (responses && responses.length > 0) {
                console.log('🔍 最初の回答データ:', responses[0]);
                console.log('🔍 date_responses構造:', responses[0].date_responses);

                // 全回答のステータス値を一覧表示
                const statusList = responses.map(r => ({ name: r.participant_name, status: r.status }));
                console.log('🔍 全回答のステータス一覧:', statusList);

                // ユニークなステータス値を抽出
                const uniqueStatuses = [...new Set(responses.map(r => r.status))];
                console.log('🔍 使用されているステータス値:', uniqueStatuses);
            }

            // 既存のグラフを破棄
            if (scheduleChart) {
                scheduleChart.destroy();
            }

            // 実際の候補日程を使用（テストデータは削除）
            let actualDates = currentEvent.candidate_dates || [];

            // グラフでも重複除去
            const uniqueGraphDates = [...new Set(actualDates)];
            if (actualDates.length !== uniqueGraphDates.length) {
                console.warn('🔧 グラフ用データでも重複を除去:', actualDates.length, '→', uniqueGraphDates.length);
                actualDates = uniqueGraphDates;
            }

            console.log('実際の候補日程:', actualDates);

            // 各候補日時の統計を計算
            const dateStats = actualDates.map(dateStr => {
                const date = new Date(dateStr);
                const label = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                console.log(`日付処理中: ${dateStr} -> ${label}`);

                // 表の表示ロジックと同じ判定を使用してカウント
                let attending = 0;
                let maybe = 0;
                let notAttending = 0;

                responses.forEach(response => {
                    // 表の表示ロジックと同じ判定を使用
                    const tableStatus = getStatusForDate(response, dateStr);

                    if (tableStatus === 'attending') {
                        attending++;
                        console.log(`✅ ${response.participant_name}: 参加`);
                    } else if (tableStatus === 'maybe') {
                        maybe++;
                        console.log(`⚠️ ${response.participant_name}: 未定`);
                    } else {
                        notAttending++;
                        console.log(`❌ ${response.participant_name}: 不参加`);
                    }
                });

                console.log(`${label}: 参加=${attending}, 不参加=${notAttending}, 未定=${maybe}`);

                return {
                    label,
                    attending,
                    notAttending,
                    maybe,
                    total: attending + notAttending + maybe
                };
            });

            // 回答が0件の場合の表示処理
            const chartContainer = document.getElementById('chart-container');
            // 既存の「データなし」メッセージがあれば削除
            const existingNoData = document.getElementById('chart-no-data');
            if (existingNoData) existingNoData.remove();

            if (responses.length === 0) {
                if (scheduleChart) {
                    scheduleChart.destroy();
                    scheduleChart = null;
                }
                canvas.style.display = 'none';

                const noDataDiv = document.createElement('div');
                noDataDiv.id = 'chart-no-data';
                noDataDiv.className = 'flex flex-col items-center justify-center py-12 text-gray-400 bg-stone-50/50 rounded-xl border border-dashed border-stone-200';
                noDataDiv.innerHTML = `
                    <svg class="w-12 h-12 mb-3 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span class="text-sm font-medium">まだ回答がありません</span>
                `;
                chartContainer.appendChild(noDataDiv);
                return;
            } else {
                canvas.style.display = 'block';
            }

            const ctx = canvas.getContext('2d');

            // 参加者数の最大値を取得して強弱を計算
            const attendingCounts = dateStats.map(stat => stat.attending);
            const maxAttending = Math.max(...attendingCounts);

            // 最も参加者が多い日程のみ緑色、他はグレー（Notion風カラー）
            const backgroundColors = attendingCounts.map(count => {
                if (maxAttending === 0) return 'rgba(153, 27, 27, 0.1)'; // 全て0の場合は薄い赤
                if (count === maxAttending && count > 0) {
                    return 'rgba(15, 123, 15, 0.8)'; // Notion風緑 - 最人気の日程のみ
                } else {
                    return 'rgba(107, 114, 128, 0.3)'; // グレー - その他の日程
                }
            });

            const borderColors = attendingCounts.map(count => {
                if (maxAttending === 0) return 'rgba(153, 27, 27, 0.4)'; // 全て0の場合
                if (count === maxAttending && count > 0) {
                    return 'rgba(15, 123, 15, 1.0)'; // Notion風緑 - 最人気の日程のみ
                } else {
                    return 'rgba(75, 85, 99, 0.5)'; // グレー - その他の日程
                }
            });

            console.log('最大参加者数:', maxAttending);
            console.log('色付け対象:', attendingCounts.map((count, index) =>
                count === maxAttending && count > 0 ? `${dateStats[index].label}: 緑色` : `${dateStats[index].label}: グレー`
            ));

            scheduleChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dateStats.map(stat => stat.label),
                    datasets: [{
                        label: '参加者数',
                        data: attendingCounts,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 2,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '日程別参加者数',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#37352F'
                        },
                        legend: {
                            display: false // シンプルにするため凡例を非表示
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function (context) {
                                    const dataIndex = context.dataIndex;
                                    const stats = dateStats[dataIndex];

                                    console.log('🔍 グラフツールチップ:', {
                                        dataIndex,
                                        label: stats.label,
                                        attending: stats.attending,
                                        maybe: stats.maybe,
                                        notAttending: stats.notAttending,
                                        total: stats.total
                                    });

                                    const attending = stats.attending;
                                    const notAttending = stats.notAttending;
                                    const maybe = stats.maybe;
                                    const total = stats.total;

                                    const isTopChoice = attending === maxAttending && attending > 0;
                                    const topChoiceLabel = isTopChoice ? '【最人気の日程】' : '';

                                    return [
                                        topChoiceLabel,
                                        `参加: ${attending}名`,
                                        `未定: ${maybe}名`,
                                        `不参加: ${notAttending}名`,
                                        `合計回答: ${total}名`
                                    ].filter(Boolean); // 空文字列を除外
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '候補日時',
                                color: '#6B6B6B',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            },
                            border: {
                                color: '#e5e7eb'
                            },
                            ticks: {
                                color: '#6B6B6B',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '参加者数',
                                color: '#6B6B6B',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            grid: {
                                color: '#f9fafb',
                                borderColor: '#e5e7eb',
                                borderWidth: 1
                            },
                            ticks: {
                                color: '#6B6B6B',
                                font: {
                                    size: 11
                                },
                                stepSize: 1
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });

            console.log('日程別回答状況グラフを作成しました');
            console.log('グラフデータ:', dateStats);
            console.log('回答データ件数:', responses.length);
        }

        // 表示切り替え機能
        function initializeViewToggle() {
            const chartViewBtn = document.getElementById('chart-view-btn');
            const tableViewBtn = document.getElementById('table-view-btn');
            const chartContainer = document.getElementById('chart-container');
            const tableContainer = document.getElementById('table-container');

            if (!chartViewBtn || !tableViewBtn || !chartContainer || !tableContainer) return;

            // グラフ表示
            chartViewBtn.addEventListener('click', function () {
                chartContainer.style.display = 'block';
                tableContainer.style.display = 'none';
                const mobileScheduleList = document.getElementById('mobile-schedule-list');
                if (mobileScheduleList) mobileScheduleList.style.display = 'none';

                chartViewBtn.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                chartViewBtn.classList.remove('text-gray-600', 'hover:text-gray-900');

                tableViewBtn.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                tableViewBtn.classList.add('text-gray-600', 'hover:text-gray-900');
            });

            // 表表示
            tableViewBtn.addEventListener('click', function () {
                chartContainer.style.display = 'none';
                tableContainer.style.removeProperty('display'); // hidden md:block で制御
                const mobileScheduleList = document.getElementById('mobile-schedule-list');
                if (mobileScheduleList) mobileScheduleList.style.removeProperty('display'); // block md:hidden で制御

                tableViewBtn.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                tableViewBtn.classList.remove('text-gray-600', 'hover:text-gray-900');

                chartViewBtn.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                chartViewBtn.classList.add('text-gray-600', 'hover:text-gray-900');
            });
        }


        // 初期化
        // Supabaseライブラリの読み込みを待つ
        function waitForSupabase() {
            return new Promise((resolve, reject) => {
                if (typeof window.supabase !== 'undefined') {
                    resolve();
                    return;
                }

                let attempts = 0;
                const maxAttempts = 50; // 5秒待機
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.supabase !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Supabaseライブラリの読み込みがタイムアウトしました'));
                    }
                }, 100);
            });
        }

        // ステータス表示を更新するヘルパー関数
        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loading-status');
            if (statusElement) {
                statusElement.textContent = `ステータス: ${message}`;
                statusElement.style.display = 'block';
            }
            console.log(`📊 ステータス: ${message}`);
        }

        // ========================================
        // エラーハンドリングシステム
        // ========================================

        // エラー分類
        const ErrorType = {
            NETWORK: 'network',
            PERMISSION: 'permission',
            DATA_NOT_FOUND: 'data_not_found',
            VALIDATION: 'validation',
            TIMEOUT: 'timeout',
            SYSTEM: 'system',
            UNKNOWN: 'unknown'
        };

        // エラー分類関数
        function classifyError(error) {
            const errorMessage = error?.message?.toLowerCase() || '';
            const errorCode = error?.code?.toLowerCase() || '';

            // ネットワークエラー
            if (errorMessage.includes('network') ||
                errorMessage.includes('fetch') ||
                errorMessage.includes('connection') ||
                errorMessage.includes('タイムアウト') ||
                errorMessage.includes('timeout')) {
                return ErrorType.NETWORK;
            }

            // 権限エラー
            if (errorCode === '42501' ||
                errorMessage.includes('permission') ||
                errorMessage.includes('権限') ||
                errorMessage.includes('unauthorized')) {
                return ErrorType.PERMISSION;
            }

            // データが見つからない
            if (errorCode === 'pgrst116' ||
                errorMessage.includes('not found') ||
                errorMessage.includes('見つかりません') ||
                errorMessage.includes('does not exist')) {
                return ErrorType.DATA_NOT_FOUND;
            }

            // タイムアウト
            if (errorMessage.includes('timeout') ||
                errorMessage.includes('タイムアウト')) {
                return ErrorType.TIMEOUT;
            }

            // バリデーションエラー
            if (errorMessage.includes('validation') ||
                errorMessage.includes('invalid') ||
                errorMessage.includes('入力してください')) {
                return ErrorType.VALIDATION;
            }

            // システムエラー
            if (errorMessage.includes('supabase') ||
                errorMessage.includes('database') ||
                errorMessage.includes('データベース')) {
                return ErrorType.SYSTEM;
            }

            return ErrorType.UNKNOWN;
        }

        // ユーザーフレンドリーなエラーメッセージを取得
        function getUserFriendlyErrorMessage(errorType) {
            const messages = {
                [ErrorType.NETWORK]: {
                    title: 'インターネット接続エラー',
                    message: 'インターネット接続を確認してください。Wi-Fiやモバイルデータ通信が有効になっているか確認し、再度お試しください。',
                    icon: 'wifi-slash'
                },
                [ErrorType.PERMISSION]: {
                    title: 'アクセス権限エラー',
                    message: 'このデータへのアクセス権限がありません。イベント作成者に確認するか、正しいURLでアクセスしているか確認してください。',
                    icon: 'lock'
                },
                [ErrorType.DATA_NOT_FOUND]: {
                    title: 'データが見つかりません',
                    message: 'イベント情報が見つかりませんでした。URLが正しいか確認するか、イベント作成者に連絡してください。',
                    icon: 'search'
                },
                [ErrorType.VALIDATION]: {
                    title: '入力エラー',
                    message: '入力内容に問題があります。必須項目がすべて入力されているか確認してください。',
                    icon: 'alert'
                },
                [ErrorType.TIMEOUT]: {
                    title: '接続タイムアウト',
                    message: 'サーバーへの接続に時間がかかりすぎています。しばらく待ってから再度お試しください。',
                    icon: 'clock'
                },
                [ErrorType.SYSTEM]: {
                    title: 'システムエラー',
                    message: '一時的なシステムエラーが発生しました。しばらく待ってから再度お試しください。',
                    icon: 'server'
                },
                [ErrorType.UNKNOWN]: {
                    title: '予期しないエラー',
                    message: '予期しないエラーが発生しました。問題が解決しない場合は、サポートまでご連絡ください。',
                    icon: 'alert'
                }
            };

            return messages[errorType] || messages[ErrorType.UNKNOWN];
        }

        // エラー表示関数（改善版）
        function showError(error, technicalDetails = null) {
            // エラー分類
            const errorType = classifyError(error);
            const errorInfo = getUserFriendlyErrorMessage(errorType);

            // UI要素を更新
            const errorDisplay = document.getElementById('error-display');
            const errorTitle = document.getElementById('error-title');
            const errorMessage = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');

            if (errorDisplay && errorTitle && errorMessage) {
                errorTitle.textContent = errorInfo.title;
                errorMessage.textContent = errorInfo.message;
                errorDisplay.style.display = 'block';

                // 技術的詳細を追加（開発者向け）
                if (errorDetails && technicalDetails) {
                    errorDetails.textContent = technicalDetails;
                }

                // ローディング状態を非表示
                const loadingStatus = document.getElementById('loading-status');
                if (loadingStatus) {
                    loadingStatus.style.display = 'none';
                }
            }

            // コンソールに詳細ログ（開発者向け）
            console.error('❌ エラー発生:', {
                type: errorType,
                userMessage: errorInfo.message,
                originalError: error,
                technicalDetails: technicalDetails,
                timestamp: new Date().toISOString()
            });
        }

        // リトライ機能
        function retryLoadData() {
            console.log('🔄 データ再読み込み開始');
            // エラー表示を非表示
            const errorDisplay = document.getElementById('error-display');
            if (errorDisplay) {
                errorDisplay.style.display = 'none';
            }
            // ページをリロード
            window.location.reload();
        }

        document.addEventListener('DOMContentLoaded', async function () {
            console.log('🍙 KANJY初期化開始');
            updateLoadingStatus('初期化開始');

            try {
                // Supabaseライブラリの読み込みを待つ
                updateLoadingStatus('Supabaseライブラリ読み込み中...');
                console.log('⏳ Supabaseライブラリの読み込みを待機中...');
                await waitForSupabase();
                console.log('✅ Supabaseライブラリ読み込み完了');
                updateLoadingStatus('Supabaseクライアント初期化中...');

                // Supabaseクライアント初期化
                console.log('🔧 Supabaseクライアント初期化開始');
                console.log('🔧 window.supabase:', typeof window.supabase);
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabaseライブラリが読み込まれていません');
                }
                // Supabaseクライアントの初期化（Realtimeオプションを追加 + キャッシュ無効化）
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    realtime: {
                        params: {
                            eventsPerSecond: 10,
                        },
                    },
                    global: {
                        headers: {
                            'Cache-Control': 'no-store'
                        }
                    }
                });
                console.log('✅ Supabaseクライアント初期化完了');
                updateLoadingStatus('データベース接続テスト中...');

                // Supabase接続テスト（シンプルなクエリで確認）
                console.log('🔍 Supabase接続テスト開始');
                console.log('🔍 Supabase URL:', SUPABASE_URL);
                console.log('🔍 Supabase Key:', SUPABASE_ANON_KEY.substring(0, 20) + '...');

                try {
                    // タイムアウトを設定（10秒）
                    let timeoutId;
                    const timeoutPromise = new Promise((_, reject) => {
                        timeoutId = setTimeout(() => reject(new Error('接続タイムアウト（10秒以内に応答がありませんでした）')), 10000);
                    });

                    const queryPromise = supabase
                        .from('events')
                        .select('id')
                        .limit(1)
                        .then(result => {
                            clearTimeout(timeoutId);
                            return result;
                        });

                    const result = await Promise.race([queryPromise, timeoutPromise]);
                    const { data: testData, error: testError } = result;

                    if (testError) {
                        console.error('❌ Supabase接続テストエラー:', testError);
                        console.error('❌ エラー詳細:', JSON.stringify(testError, null, 2));
                        console.error('❌ エラーコード:', testError.code);
                        console.error('❌ エラーメッセージ:', testError.message);

                        let errorMessage = 'データベースへの接続エラーが発生しました。';
                        if (testError.message) {
                            errorMessage += `\n\n詳細: ${testError.message}`;
                        }
                        if (testError.code === 'PGRST116' || testError.message?.includes('not found')) {
                            errorMessage += '\n\nテーブル「events」が見つかりません。データベースのテーブル構造を確認してください。';
                        } else if (testError.code === '42501' || testError.message?.includes('permission')) {
                            errorMessage += '\n\nデータベースへのアクセス権限がありません。RLSポリシーを確認してください。';
                        } else if (testError.message?.includes('network') || testError.message?.includes('fetch')) {
                            errorMessage += '\n\nネットワークエラーが発生しました。インターネット接続を確認してください。';
                        }

                        throw new Error(errorMessage);
                    } else {
                        console.log('✅ Supabase接続テスト成功');
                        console.log('✅ テストデータ:', testData);
                        updateLoadingStatus('イベントデータ読み込み中...');
                    }
                } catch (testError) {
                    console.error('❌ Supabase接続テスト失敗:', testError);
                    if (testError.message?.includes('タイムアウト')) {
                        throw new Error('データベースへの接続がタイムアウトしました。Supabaseデータベースが起動しているか確認してください。');
                    }
                    throw testError;
                }
            } catch (error) {
                // タイトルを更新
                const titleElement = document.getElementById('event-title');
                if (titleElement) {
                    titleElement.textContent = 'データベースへの接続に失敗しました';
                    titleElement.style.color = '#ef4444';
                }

                // 技術的詳細を準備
                const technicalDetails = [
                    `エラー: ${error.message || '不明'}`,
                    `コード: ${error.code || 'N/A'}`,
                    `タイムスタンプ: ${new Date().toISOString()}`,
                    error.stack ? `\nスタック:\n${error.stack}` : ''
                ].filter(Boolean).join('\n');

                // 新しいエラー表示システムを使用
                showError(error, technicalDetails);
                return;
            }

            // URLパラメータからイベントIDを取得
            const urlParams = new URLSearchParams(window.location.search);
            let eventId = urlParams.get('id');
            const timestamp = urlParams.get('t'); // キャッシュバスティング用タイムスタンプ
            const shouldRefresh = urlParams.has('refresh'); // データ再取得フラグ

            // refreshパラメータがある場合、URLから削除（履歴をきれいに保つ）
            if (shouldRefresh) {
                console.log('🔄 refresh パラメータを検出しました - データを再取得します');
                urlParams.delete('refresh');
                const cleanUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState({}, '', cleanUrl);
            }

            // タイムスタンプがある場合はログ出力（データが更新されたことを示す）
            if (timestamp) {
                console.log('🔄 キャッシュバスティングタイムスタンプ検出:', timestamp);
                console.log('   - 新しいデータを取得します（更新後の遷移）');
                console.log('   - Date:', new Date(parseInt(timestamp)));
            }

            if (!eventId) {
                alert('イベントIDが指定されていません');
                return;
            }

            console.log('📋 URLパラメータ:');
            console.log('   - イベントID:', eventId);
            console.log('   - タイムスタンプ:', timestamp || 'なし');
            console.log('   - キャッシュ無効化:', timestamp ? '有効' : '無効');

            // UUIDを小文字に統一（iOSアプリ側でlowercased()で保存しているため）
            eventId = eventId.toLowerCase().trim();
            console.log('🔍 イベントID:', eventId);

            currentEventId = eventId;

            try {
                // debugSupabaseConnectionは時間がかかる可能性があるためスキップ
                // console.log('📊 ステップ1: Supabase接続確認を開始');
                // try {
                //     await debugSupabaseConnection();
                //     console.log('✅ ステップ1完了: Supabase接続確認成功');
                // } catch (debugError) {
                //     console.warn('⚠️ ステップ1警告: Supabase接続確認でエラー（続行します）:', debugError);
                // }

                console.log('📊 ステップ1: イベントデータ読み込みを開始');
                updateLoadingStatus('イベントデータ読み込み中...');
                // イベントを最初に読み込み（ヘッダー生成のため）
                await loadEvent(eventId);
                console.log('✅ ステップ1完了: イベントデータ読み込み成功');
                updateLoadingStatus('回答データ読み込み中...');

                console.log('📊 ステップ2: 回答データ読み込みを開始');
                // 次に回答を読み込み（ヘッダー生成後）
                await loadResponses(eventId);
                console.log('✅ ステップ2完了: 回答データ読み込み成功');

                console.log('🍙 データ読み込み完了');
                updateLoadingStatus('読み込み完了');

                // refreshフラグがある場合、データを再取得（編集後の更新反映用）
                if (shouldRefresh) {
                    console.log('🔄 データを再取得します（編集後の更新反映）');
                    console.log('⏱️  データベースへの反映を待ってから再取得します');

                    // データベースへの反映を待つ（Supabaseの反映遅延を考慮）
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // データを再取得
                    console.log('📊 データ再取得: イベントデータ');
                    await loadEvent(eventId);
                    console.log('📊 データ再取得: 回答データ');
                    await loadResponses(eventId);
                    console.log('✅ データ再取得完了 - 最新データが表示されています');
                }

                // 表示切り替え機能を初期化
                initializeViewToggle();

                // ステータス表示を非表示
                setTimeout(() => {
                    const statusElement = document.getElementById('loading-status');
                    if (statusElement) {
                        statusElement.style.display = 'none';
                    }
                }, 1000);

            } catch (error) {
                // エラー時にタイトルを更新
                const titleElement = document.getElementById('event-title');
                if (titleElement) {
                    titleElement.textContent = 'データの読み込みに失敗しました';
                    titleElement.style.color = '#ef4444';
                }

                // 技術的詳細を準備
                const technicalDetails = [
                    `エラー: ${error.message || '不明'}`,
                    `コード: ${error.code || 'N/A'}`,
                    `タイムスタンプ: ${new Date().toISOString()}`,
                    error.stack ? `\nスタック:\n${error.stack}` : ''
                ].filter(Boolean).join('\n');

                // 新しいエラー表示システムを使用
                showError(error, technicalDetails);
            }

            // アニメーション設定
            setupAnimations();

            // Realtime Subscriptionの設定
            if (currentEventId) {
                setupRealtimeSubscription(currentEventId);
            }

            // URLパラメータによるアクション処理 (action=responded など)
            handleActionParam();

            // 回答フォームへの遷移ボタンのイベントリスナー設定
            const goToResponseFormBtn = document.getElementById('go-to-response-form-btn');
            if (goToResponseFormBtn) {
                console.log('✅ 回答フォームボタンが見つかりました');

                // タッチイベント（モバイル用）
                // iOS では touchend → click の順で発火し、両方が goToResponseForm() を呼び出すと
                // 2つのナビゲーションが競合してエラー -999（キャンセル）が発生するため
                // isNavigatingフラグで重複実行を防止
                goToResponseFormBtn.addEventListener('touchend', function (e) {
                    console.log('📱 ボタンがタップされました（touchend）');
                    e.preventDefault();
                    e.stopPropagation();
                    goToResponseForm();
                }, { passive: false });

                // クリックイベント（デスクトップ用）
                // タッチデバイスでもclickは発火するが、isNavigatingフラグで保護される
                goToResponseFormBtn.addEventListener('click', function (e) {
                    console.log('🖱️ ボタンがクリックされました（click）');
                    e.preventDefault();
                    e.stopPropagation();
                    goToResponseForm();
                });

                console.log('✅ イベントリスナー設定完了（touchend + click with flag protection）');
            } else {
                console.warn('⚠️ 回答フォームボタンが見つかりませんでした');
            }

            console.log('🎉 Beautiful KANJY Table loaded successfully!');

            // デバッグ用：グローバル変数を公開
            window.debugInfo = {
                currentEventId: currentEventId,
                responses: window.responses,
                currentEvent: currentEvent
            };

            console.log('');
            console.log('🔧 デバッグ情報:');
            console.log('   - currentEventId:', currentEventId);
            console.log('   - 回答数:', window.responses?.length || 0);
            console.log('   - editResponse関数:', typeof window.editResponse);
            console.log('');
            console.log('💡 テストコマンド:');
            console.log('   - window.editResponse("テストID") // 編集機能をテスト');
            console.log('   - window.debugInfo // デバッグ情報を表示');
            console.log('');
        });

        // イベント情報を読み込み
        async function loadEvent(eventId) {
            try {
                console.log('📥 イベント読み込み開始:', eventId);
                console.log('📥 イベントIDの型:', typeof eventId);
                console.log('📥 イベントIDの値:', JSON.stringify(eventId));

                // Supabaseクエリを実行（配列で取得）
                console.log('📥 Supabaseクエリ実行前');
                console.log('📥 supabaseオブジェクト:', supabase);
                console.log('📥 クエリ対象イベントID:', eventId);

                const queryStartTime = Date.now();
                let queryResult;
                try {
                    console.log('📥 Supabaseクエリ実行中...');
                    queryResult = await supabase
                        .from('events')
                        .select('*')
                        .eq('id', eventId);
                    const queryEndTime = Date.now();
                    console.log(`📥 Supabaseクエリ実行完了（${queryEndTime - queryStartTime}ms）`);
                } catch (queryError) {
                    const queryEndTime = Date.now();
                    console.error(`❌ Supabaseクエリ実行エラー（${queryEndTime - queryStartTime}ms）:`, queryError);
                    throw queryError;
                }

                const { data: events, error } = queryResult;

                console.log('🔍 Supabaseクエリ結果:');
                console.log('  - データ:', events);
                console.log('  - データ型:', typeof events);
                console.log('  - エラー:', error);
                console.log('  - データ件数:', events ? events.length : 0);

                if (error) {
                    console.error('❌ Supabaseエラー:', error);
                    throw error;
                }

                if (!events || events.length === 0) {
                    console.warn('⚠️ イベントが見つかりません。利用可能なイベントを確認中...');
                    // イベントが見つからない場合、利用可能なイベントを表示
                    const { data: availableEvents, error: availableError } = await supabase
                        .from('events')
                        .select('id, title, created_at')
                        .order('created_at', { ascending: false })
                        .limit(5);

                    console.log('利用可能なイベント:', availableEvents);

                    let errorMessage = `イベントID "${eventId}" が見つかりません。`;
                    if (availableEvents && availableEvents.length > 0) {
                        errorMessage += '\n\n利用可能なイベント:';
                        availableEvents.forEach(event => {
                            errorMessage += `\n- ${event.title || 'タイトルなし'} (ID: ${event.id})`;
                        });
                    }

                    throw new Error(errorMessage);
                }

                const event = events[0];

                // イベントオブジェクトの検証
                if (!event) {
                    throw new Error('イベントデータが不正です');
                }

                // タイトルの検証
                if (!event.title || event.title.trim() === '') {
                    console.warn('⚠️ イベントタイトルが空です。デフォルト値を設定します。');
                    event.title = 'イベント名が設定されていません';
                }

                console.log('🔍 最初のイベント詳細:');
                console.log('  - ID:', event.id);
                console.log('  - タイトル:', event.title);
                console.log('  - candidate_dates:', event.candidate_dates);
                console.log('  - candidate_dates型:', typeof event.candidate_dates);
                console.log('  - candidate_dates長さ:', event.candidate_dates ? event.candidate_dates.length : 'null');

                if (event.candidate_dates && Array.isArray(event.candidate_dates)) {
                    event.candidate_dates.forEach((date, index) => {
                        console.log(`  - 日付${index + 1}:`, date);
                    });
                }

                // 時間データを修正（19:00 UTC → 10:00 UTC に変換して19:00 JSTで表示）
                if (event.candidate_dates) {
                    event.candidate_dates = event.candidate_dates.map(dateStr => {
                        const date = new Date(dateStr);
                        if (date.getUTCHours() === 19) {
                            // 19:00 UTCを10:00 UTCに変更（日本時間19:00にするため）
                            date.setUTCHours(10);
                            return date.toISOString();
                        }
                        return dateStr;
                    });
                    console.log('🔧 時間データ修正完了:', event.candidate_dates);
                }

                currentEvent = event;
                console.log('🔧 currentEvent設定完了:');
                console.log('  - ID:', event.id);
                console.log('  - タイトル:', event.title);
                console.log('  - candidate_dates:', event.candidate_dates);
                console.log('  - currentEvent.candidate_dates:', currentEvent.candidate_dates);

                // 設定直後に重複チェック
                if (currentEvent.candidate_dates && Array.isArray(currentEvent.candidate_dates)) {
                    const uniqueCheck = [...new Set(currentEvent.candidate_dates)];
                    console.log('🔧 設定直後の重複チェック:');
                    console.log('  - 元の長さ:', currentEvent.candidate_dates.length);
                    console.log('  - 重複除去後:', uniqueCheck.length);
                    if (currentEvent.candidate_dates.length !== uniqueCheck.length) {
                        console.warn('⚠️ currentEvent設定時点で既に重複があります!');
                        console.log('  - 重複あり:', currentEvent.candidate_dates);
                        console.log('  - 重複除去後:', uniqueCheck);
                    }
                }
                // イベント情報を表示（即座に実行）
                console.log('✅ イベントデータ取得成功、表示処理を開始');
                console.log('✅ イベントデータ:', JSON.stringify(event, null, 2));
                displayEvent(event);
                console.log('✅ displayEvent呼び出し完了');

            } catch (error) {
                console.error('❌ イベント読み込みエラー:', error);
                console.error('❌ エラー詳細:', error.message);
                console.error('❌ エラースタック:', error.stack);

                // エラー時にユーザーに分かりやすいメッセージを表示
                const titleElement = document.getElementById('event-title');
                if (titleElement) {
                    titleElement.textContent = 'データの読み込みに失敗しました';
                    titleElement.style.color = '#ef4444'; // エラー色
                }

                // エラーメッセージを表示
                const errorMessage = error.message || '不明なエラーが発生しました';
                alert(`データの読み込みに失敗しました:\n\n${errorMessage}\n\nページをリロードして再試行してください。`);

                throw error;
            }
        }

        // 回答を読み込み
        async function loadResponses(eventId) {
            try {
                console.log('回答読み込み開始:', eventId);

                const { data: responses, error } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                console.log('回答クエリ結果:', { responses, error });

                if (error) throw error;

                // 削除済みレコードをフィルタリング
                const activeResponses = (responses || []).filter(response => {
                    const isDeleted = response.participant_name && response.participant_name.startsWith('[削除済み]');
                    if (isDeleted) {
                        console.log('🗑️ 削除済みレコードを非表示:', response.participant_name);
                    }
                    return !isDeleted;
                });

                console.log('📊 フィルタリング結果:', {
                    total: responses ? responses.length : 0,
                    deleted: responses ? responses.length - activeResponses.length : 0,
                    active: activeResponses.length
                });

                // 回答データの時間も修正（19:00 UTC → 10:00 UTC）
                activeResponses.forEach(response => {
                    if (response.available_dates && Array.isArray(response.available_dates)) {
                        response.available_dates = response.available_dates.map(dateStr => {
                            const date = new Date(dateStr);
                            if (date.getUTCHours() === 19) {
                                date.setUTCHours(10);
                                return date.toISOString();
                            }
                            return dateStr;
                        });
                    }
                });
                console.log('🔧 回答データの時間修正完了');

                currentResponses = activeResponses;
                console.log('読み込んだ回答:', activeResponses);

                // 表示制限フラグをリセット
                showingAll = false;

                displayResponses(activeResponses);

            } catch (error) {
                console.error('回答読み込みエラー:', error);
                console.error('エラー詳細:', error.message);
                console.error('スタックトレース:', error.stack);

                // エラーをより詳しく調査
                if (error.name) console.error('エラー名:', error.name);
                if (error.code) console.error('エラーコード:', error.code);

                throw error;
            }
        }

        // イベント情報を表示
        function displayEvent(event) {
            console.log('🍙 イベント情報表示開始:', event);

            // 共有ロジックでタイトル・説明・場所・予算・期限を表示
            window.displayEventInfo(event);

            if (!event) return;

            // イベントURLを表示（index.html固有の処理）
            const eventUrlElement = document.getElementById('eventUrl');
            if (eventUrlElement && event.id) {
                const fullUrl = `${window.location.origin}${window.location.pathname}?id=${event.id}`;
                eventUrlElement.value = fullUrl; // input要素の場合はvalueに設定
                console.log('✅ イベントURL設定完了:', fullUrl);
            } else {
                console.warn('⚠️ eventUrl要素またはevent.idが見つかりません');
            }

            // カードの数に応じてグリッドレイアウトを調整
            updateGridLayout();

            // 候補日時を動的に生成
            if (event.candidate_dates && Array.isArray(event.candidate_dates)) {
                console.log('🍙 候補日時:', event.candidate_dates);
                console.log('🍙 候補日時の数:', event.candidate_dates.length);
                event.candidate_dates.forEach((date, index) => {
                    console.log(`🍙 日付${index + 1}:`, date);
                });
                generateDateHeaders(event.candidate_dates);
            } else {
                console.warn('⚠️ 候補日時が見つかりません:', event.candidate_dates);
            }

            console.log('🍙 イベント情報表示完了');
        }

        // カードの数に応じてグリッドレイアウトを調整
        function updateGridLayout() {
            const cardsContainer = document.getElementById('event-info-cards');
            if (!cardsContainer) return;

            const visibleCards = cardsContainer.querySelectorAll('[id$="-card"][style*="block"], [id$="-card"]:not([style*="none"])');
            const cardCount = Array.from(visibleCards).filter(card =>
                card.style.display !== 'none'
            ).length;

            // カードの数に応じてグリッドクラスを調整
            cardsContainer.className = 'grid gap-6 ' +
                (cardCount === 1 ? 'grid-cols-1 max-w-md mx-auto' :
                    cardCount === 2 ? 'grid-cols-1 md:grid-cols-2 max-w-2xl mx-auto' :
                        'grid-cols-1 md:grid-cols-3');
        }

        // 参加人数を計算する関数
        function calculateParticipantCount(dateStr) {
            console.log('🔍 =====================');
            console.log('🔍 参加者数計算開始:', dateStr);
            console.log('🔍 =====================');

            if (!window.responses || !Array.isArray(window.responses)) {
                console.warn('⚠️ window.responsesが存在しません');
                return { attending: 0, maybe: 0, notAttending: 0 };
            }

            console.log('🔍 回答データ数:', window.responses.length);
            console.log('🔍 全参加者のステータス一覧:');
            window.responses.forEach((response, index) => {
                console.log(`  ${index + 1}. ${response.participant_name}: ${response.status} | available_dates:`, response.available_dates);
            });

            let attending = 0;
            let maybe = 0;
            let notAttending = 0;

            console.log('🔍 =====================');
            console.log(`🔍 ${dateStr} の詳細計算開始`);
            console.log('🔍 =====================');

            window.responses.forEach((response, index) => {
                console.log(`🔍 ${response.participant_name}: status=${response.status}, available_dates=`, response.available_dates);

                // 日付の比較を改善（異なる形式に対応）
                const isDateAvailable = response.available_dates && response.available_dates.some(availableDate => {
                    // 両方をDateオブジェクトに変換して比較
                    const date1 = new Date(dateStr);
                    const date2 = new Date(availableDate);
                    const match = date1.getTime() === date2.getTime();
                    return match;
                });
                console.log(`🔍 ${response.participant_name}: 日付利用可能 = ${isDateAvailable}`);

                // 表の表示ロジックと同じ判定を使用
                const tableStatus = getStatusForDate(response, dateStr);

                if (tableStatus === 'attending') {
                    attending++;
                    console.log(`✅ ${response.participant_name}: 参加 (+1) 合計=${attending}`);
                } else if (tableStatus === 'maybe') {
                    maybe++;
                    console.log(`⚠️ ${response.participant_name}: 未定 (+1) 合計=${maybe}`);
                } else {
                    // 'notAttending' または その他
                    notAttending++;
                    console.log(`❌ ${response.participant_name}: 不参加 (+1) 合計=${notAttending}`);
                }
            });

            console.log('🔍 =====================');
            console.log(`📊 ${dateStr} 最終結果:`);
            console.log(`   参加: ${attending}名`);
            console.log(`   未定: ${maybe}名`);
            console.log(`   不参加: ${notAttending}名`);
            console.log(`   総計: ${attending + maybe + notAttending}名`);
            console.log('🔍 =====================');

            return { attending, maybe, notAttending };
        }

        // Realtime Subscriptionの設定
        function setupRealtimeSubscription(eventId) {
            console.log('🔌 Realtime Subscription Setup for:', eventId);

            // 既存のサブスクリプションがあれば解除（必要に応じて）
            // supabase.removeAllChannels(); // 注意: 他のチャンネルも解除されるので慎重に

            const channel = supabase.channel(`event_${eventId}`)
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'responses',
                        filter: `event_id=eq.${eventId}`
                    },
                    (payload) => {
                        console.log('⚡️ Realtime update received:', payload);

                        // データ更新の通知（トースト）
                        if (payload.eventType === 'INSERT') {
                            showNotification('新しい回答', '新しい回答が追加されました', 'success');
                        } else if (payload.eventType === 'UPDATE') {
                            showNotification('回答更新', '回答データが更新されました', 'info');
                        } else if (payload.eventType === 'DELETE') {
                            showNotification('回答削除', '回答が削除されました', 'info');
                        }

                        // 少し待ってからデータを再取得（反映待ち）
                        setTimeout(() => {
                            console.log('🔄 Realtime更新に伴うデータ再取得');
                            loadResponses(eventId);
                            // イベントデータも更新（候補日時の人気度などが変わる可能性があるため）
                            // ただし頻繁な更新を避けるため、ここでは回答のみにするか要検討
                            // loadEvent(eventId); 
                        }, 500);
                    }
                )
                .subscribe((status) => {
                    console.log('🔌 Subscription status:', status);

                    // TODO: デバッグ完了後に削除


                    if (status === 'SUBSCRIBED') {
                        console.log('✅ Realtime接続成功');

                        // showNotification('接続完了', 'リアルタイム更新が有効になりました', 'success');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('❌ Realtime接続エラー');

                        showNotification('接続エラー', 'リアルタイム更新の接続に失敗しました', 'error');
                    } else if (status === 'TIMED_OUT') {
                        console.error('❌ Realtime接続タイムアウト');

                        showNotification('接続タイムアウト', 'リアルタイム更新の接続がタイムアウトしました', 'error');
                    }
                });

            console.log('🔌 Subscribed to changes for event:', eventId);


        }

        // アクションパラメータの処理
        function handleActionParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');

            if (action === 'responded') {
                console.log('🎉 回答完了アクションを検出しました');

                // URLからパラメータを削除
                urlParams.delete('action');
                // refreshなども削除
                if (urlParams.has('refresh')) urlParams.delete('refresh');
                if (urlParams.has('_t')) urlParams.delete('_t');

                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState({}, '', newUrl);

                // 成功メッセージを表示
                showLargeSuccessMessage('回答ありがとうございます！', '回答を受け付けました。');

                // 念入りなデータ再取得（データベースの反映遅延対策）
                // ユーザーの提案通り「戻ってきた時にリロード（データ再取得）」を強化
                if (currentEventId) {
                    console.log('🔄 データの即時再取得を実行');
                    loadResponses(currentEventId);

                    // 1秒後にも再取得（念のため）
                    setTimeout(() => {
                        console.log('🔄 データの再取得(1秒後)');
                        loadResponses(currentEventId);
                    }, 1000);

                    // 3秒後にも再取得（念のため）
                    setTimeout(() => {
                        console.log('🔄 データの再取得(3秒後)');
                        loadResponses(currentEventId);
                    }, 3000);
                }
            }
        }

        // 大きな成功メッセージを表示（モーダル）
        function showLargeSuccessMessage(title, message) {
            // 既存のメッセージがあれば削除
            const existing = document.getElementById('large-success-message');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'large-success-message';
            overlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in keyframes-fade-in';
            overlay.style.animation = 'fadeIn 0.3s ease-out forwards';

            overlay.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 mx-4 max-w-sm w-full transform transition-all scale-100" style="animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-5">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${title}</h3>
                        <p class="text-gray-600 mb-6 text-base leading-relaxed">
                            ${message}<br><br>
                            <span class="text-sm text-gray-500">※もし一覧に反映されていない場合は、ブラウザの更新ボタンを押してください。</span>
                        </p>
                        <button onclick="document.getElementById('large-success-message').remove()" class="w-full bg-slate-900 text-white font-semibold py-3 px-4 rounded-xl hover:bg-slate-800 active:transform active:scale-95 transition-all duration-200 shadow-md">
                            閉じる
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                </style>
            `;

            document.body.appendChild(overlay);

            // 5秒後に自動的に消える
            setTimeout(() => {
                if (document.getElementById('large-success-message')) {
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.remove(), 300);
                }
            }, 6000); // 少し長めに表示
        }

        // 参加人数のスタイルを取得
        function getParticipantCountStyle(participantCount) {
            const total = participantCount.attending + participantCount.maybe;

            if (total >= 5) {
                return 'bg-emerald-100 text-emerald-700 border border-emerald-200';
            } else if (total >= 3) {
                return 'bg-amber-100 text-amber-700 border border-amber-200';
            } else if (total >= 1) {
                return 'bg-blue-100 text-blue-700 border border-blue-200';
            } else {
                return 'bg-stone-100 text-stone-600 border border-stone-200';
            }
        }

        // 日程ヘッダーを動的生成
        function generateDateHeaders(dates) {
            console.log('🗓️ 日程ヘッダー生成開始:', dates);
            console.log('🗓️ 日付の数:', dates ? dates.length : 0);

            // 重複チェックと強制除去
            if (dates && Array.isArray(dates)) {
                const uniqueDates = [...new Set(dates)];
                console.log('🗓️ 重複除去後:', uniqueDates);
                if (dates.length !== uniqueDates.length) {
                    console.warn('⚠️ 重複する日付が見つかりました！', dates);
                    console.log('🔧 重複を除去して続行します');
                    dates = uniqueDates; // 重複を除去した配列を使用
                }
            }

            // responsesがまだ読み込まれていない場合は、グローバル変数として初期化
            if (!window.responses) {
                window.responses = [];
            }

            // 回答一覧セクションのtheadを取得
            const sections = document.querySelectorAll('section');
            let detailTableHeader = null;

            sections.forEach(section => {
                const h2 = section.querySelector('h2');
                if (h2 && h2.textContent.includes('回答一覧')) {
                    detailTableHeader = section.querySelector('thead tr');
                    console.log('🗓️ 回答一覧のheader発見');
                }
            });

            if (!detailTableHeader) {
                console.error('❌ 回答一覧のheaderが見つかりません');
                return;
            }

            // 新しいヘッダーを完全に作り直す
            detailTableHeader.innerHTML = '';

            // 参加者ヘッダー（固定幅）
            const participantHeader = document.createElement('th');
            participantHeader.className = 'text-left py-3 px-6 font-medium text-stone-700 text-sm uppercase tracking-wider w-80';
            participantHeader.textContent = '参加者';
            detailTableHeader.appendChild(participantHeader);

            // 日程ヘッダーを追加（参加人数付き）
            dates.forEach(dateStr => {
                const date = new Date(dateStr);
                const th = document.createElement('th');
                th.className = 'py-3 px-3 text-center text-sm font-medium text-stone-700 uppercase tracking-wider';

                // この日程の参加可能人数を計算
                const participantCount = calculateParticipantCount(dateStr);

                th.innerHTML = `
                    <div class="space-y-1">
                        <div class="text-base font-semibold text-stone-900">${formatDateShort(date)}</div>
                        <div class="text-xs text-stone-600 flex items-center justify-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            ${formatTimeRange(date)}
                        </div>
                        <div class="mt-2 space-y-1 flex flex-col items-center">
                            <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ${participantCount.attending === 0 ? 'opacity-50' : ''}" style="background-color: #F0FDF4; color: #0F7B0F; border-color: #BBF7D0;">
                                <span class="mr-1">○</span>
                                <span>${participantCount.attending}名</span>
                            </div>
                            <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ${participantCount.maybe === 0 ? 'opacity-50' : ''}" style="background-color: #FFFBEB; color: #D97706; border-color: #FED7AA;">
                                <span class="mr-1">?</span>
                                <span>${participantCount.maybe}名</span>
                            </div>
                            <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ${participantCount.notAttending === 0 ? 'opacity-50' : ''}" style="background-color: #F8F9FA; color: #6B7280; border-color: #E5E7EB;">
                                <span class="mr-1">×</span>
                                <span>${participantCount.notAttending}名</span>
                            </div>
                        </div>
                    </div>
                `;
                detailTableHeader.appendChild(th);
            });

            // ヘッダー生成完了

            // ヘッダー生成完了



            console.log('🗓️ 日程ヘッダー生成完了');
        }

        // 回答を表示
        function displayResponses(responses) {
            // グローバル変数として保存（参加人数計算で使用）
            window.responses = responses || [];
            // より確実なセレクター：回答一覧セクションのtbodyを取得
            const sections = document.querySelectorAll('section');
            let detailTableBody = null;

            sections.forEach(section => {
                const h2 = section.querySelector('h2');
                if (h2 && h2.textContent.includes('回答一覧')) {
                    detailTableBody = section.querySelector('tbody');
                    console.log('✅ 回答一覧セクション発見:', h2.textContent);
                }
            });

            if (!detailTableBody || !currentEvent) {
                console.error('❌ 回答一覧のtbodyが見つかりません');
                console.log('セクション数:', sections.length);
                sections.forEach((section, index) => {
                    const h2 = section.querySelector('h2');
                    console.log(`セクション${index}:`, h2 ? h2.textContent : 'h2なし');
                });
                return;
            }

            console.log('✅ 回答一覧tbody取得成功、responses:', responses ? responses.length : 0, '件');

            detailTableBody.innerHTML = '';

            // テーブルのコンテナ要素を取得（表示切り替え用）
            const tableContainer = detailTableBody.closest('.responses-table-container');
            const parentCardBody = tableContainer ? tableContainer.parentElement : null;

            // 既存の「データなし」メッセージがあれば削除
            const existingNoData = document.getElementById('responses-no-data');
            if (existingNoData) existingNoData.remove();

            if (!responses || responses.length === 0) {
                // テーブルを非表示
                if (tableContainer) tableContainer.style.display = 'none';
                // モバイルリストも非表示
                const mobileList = document.getElementById('mobile-response-list');
                if (mobileList) mobileList.style.display = 'none';

                // シンプルな「まだ回答がありません」メッセージを表示
                if (parentCardBody) {
                    const noDataDiv = document.createElement('div');
                    noDataDiv.id = 'responses-no-data';
                    noDataDiv.className = 'flex flex-col items-center justify-center py-12 text-gray-400';
                    noDataDiv.innerHTML = `
                        <svg class="w-12 h-12 mb-3 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span class="text-sm font-medium">まだ回答がありません</span>
                    `;
                    parentCardBody.appendChild(noDataDiv);
                }

                // 「もっと表示」ボタンを非表示
                const showMoreSection = document.getElementById('show-more-section');
                if (showMoreSection) {
                    showMoreSection.style.display = 'none';
                }

                // データが0件でも、日程別状況（グラフ・表）の「データなし」表示を更新する必要がある
                updateScheduleTable(responses);
                createScheduleChart(responses);

                return;
            } else {
                // テーブルを表示 (Desktop)
                if (tableContainer) tableContainer.style.removeProperty('display'); // hidden md:block で制御されるのでstyle削除が適切だが、念のため
                // モバイルリストを表示 (Mobile)
                const mobileList = document.getElementById('mobile-response-list');
                if (mobileList) mobileList.style.removeProperty('display');
            }

            // Mobile List Container
            const mobileListContainer = document.getElementById('mobile-response-list');
            if (mobileListContainer) {
                mobileListContainer.innerHTML = '';
            }

            // 表示する回答を決定
            const displayResponses = showingAll ? responses : responses.slice(0, displayLimit);
            const remainingCount = responses.length - displayLimit;

            displayResponses.forEach((response, index) => {
                // Table Row (Desktop)
                const row = createResponseRow(response, index);
                detailTableBody.appendChild(row);

                // Card (Mobile)
                if (mobileListContainer) {
                    const card = createResponseCard(response, index);
                    mobileListContainer.appendChild(card);
                }
            });

            // 「もっと表示」ボタンの表示制御
            const showMoreSection = document.getElementById('show-more-section');
            const showMoreText = document.getElementById('show-more-text');

            if (showMoreSection && showMoreText) {
                if (showingAll || responses.length <= displayLimit) {
                    // 全件表示中、または件数が少ない場合は非表示
                    showMoreSection.style.display = 'none';
                } else {
                    // 残りがある場合は表示
                    showMoreSection.style.display = 'block';
                    showMoreText.textContent = `残り${remainingCount}名の回答を表示`;
                }
            }

            // サマリー情報を更新
            // updateSummary(responses);

            // 日程別参加状況テーブルを更新
            updateScheduleTable(responses);

            // 日程別回答状況グラフを作成
            createScheduleChart(responses);

            // 参加人数が更新されたのでヘッダーを再生成
            if (currentEvent && currentEvent.candidate_dates) {
                generateDateHeaders(currentEvent.candidate_dates);
            }

            console.log('🍙 回答表示完了:', displayResponses.length, '件 (全', responses.length, '件中)');
        }

        // 回答行を作成
        function createResponseRow(response, index = 0) {
            const tr = document.createElement('tr');
            tr.className = 'table-row';
            tr.style.borderBottom = '1px solid #E9E5E0';
            tr.style.background = index % 2 === 0 ? '#FFFFFF' : '#FAFAFA';

            // 参加者名（クリック可能なリンク、固定幅）
            const nameCell = document.createElement('td');
            nameCell.className = 'py-4 px-6 w-80';
            nameCell.style.borderRight = '1px solid #E9E5E0';

            // クリック可能なコンテナを作成
            const nameContainer = document.createElement('div');
            nameContainer.className = 'flex items-center space-x-3 cursor-pointer hover:bg-stone-50 rounded-lg p-2 transition-all duration-200';
            nameContainer.setAttribute('data-response-id', response.id); // 安全にIDを保存

            nameContainer.innerHTML = `
                <div class="w-10 h-10 bg-stone-600 rounded-full flex items-center justify-center shadow-sm">
                    <span class="text-white font-semibold text-sm">${response.participant_name.charAt(0)}</span>
                </div>
                <div>
                    <div class="text-base font-semibold text-stone-900 hover:text-stone-700 transition-colors duration-200">${response.participant_name}</div>
                    ${response.comment ? `
                        <div class="text-sm text-gray-500 max-w-xs relative group">
                            <span class="cursor-help">${response.comment.length > 10 ? response.comment.substring(0, 10) + '...' : response.comment
                    }</span>
                            ${response.comment.length > 10 ? `
                                <div class="absolute bottom-full left-0 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-150 pointer-events-none whitespace-nowrap z-50 transform -translate-y-1 group-hover:translate-y-0">
                                    ${response.comment}
                                    <div class="absolute top-full left-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
                <div class="ml-2">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </div>
            `;

            // イベントハンドラー関数（タッチとクリックで共通）
            const handleInteraction = function (event) {
                console.log('');
                console.log('═══════════════════════════════════════');
                console.log('🎯 参加者名がタップ/クリックされました！');
                console.log('═══════════════════════════════════════');
                console.log('📱 イベントタイプ:', event.type);
                console.log('🆔 data-response-id:', this.getAttribute('data-response-id'));
                console.log('🔍 currentEventId:', currentEventId);

                const responseId = this.getAttribute('data-response-id');

                if (!responseId) {
                    console.error('❌ responseIdが取得できませんでした');
                    return;
                }

                // イベント伝播を停止（重複実行を防ぐ）
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();

                console.log('🚀 editResponse関数を呼び出します');
                console.log('   - responseId:', responseId);
                console.log('═══════════════════════════════════════');
                console.log('');

                // 編集画面に遷移
                editResponse(responseId);
            };

            // タッチイベント（モバイル優先）
            nameContainer.addEventListener('touchend', handleInteraction, { capture: true, passive: false });

            // クリックイベント（デスクトップ用）
            nameContainer.addEventListener('click', handleInteraction, { capture: true });

            nameCell.appendChild(nameContainer);
            tr.appendChild(nameCell);

            // 各日程の回答
            if (currentEvent && currentEvent.candidate_dates && Array.isArray(currentEvent.candidate_dates)) {
                currentEvent.candidate_dates.forEach(dateStr => {
                    const cell = document.createElement('td');
                    cell.className = 'py-4 px-3 text-center';
                    cell.style.borderRight = '1px solid #E9E5E0';

                    // モバイル用に日程ラベルを追加
                    const date = new Date(dateStr);
                    const dateLabel = `${date.getMonth() + 1}/${date.getDate()}(${['日', '月', '火', '水', '木', '金', '土'][date.getDay()]}) ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}〜`;
                    cell.setAttribute('data-date', dateLabel);

                    const status = getStatusForDate(response, dateStr);
                    cell.innerHTML = createStatusBadge(status);

                    tr.appendChild(cell);
                });
            } else {
                console.warn('⚠️ currentEvent.candidate_datesが存在しません:', currentEvent);
                // 最低1つの日程セルを作成
                const cell = document.createElement('td');
                cell.className = 'py-4 px-3 text-center';
                cell.setAttribute('data-date', '日程未定');
                cell.innerHTML = createStatusBadge('notAttending');
                tr.appendChild(cell);
            }

            // 行生成完了

            // 行生成完了

            return tr;
        }

        // モバイル用カードを作成
        function createResponseCard(response, index) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl border border-stone-200 shadow-sm p-4 cursor-pointer active:scale-[0.98] transition-all duration-200';
            card.setAttribute('data-response-id', response.id);

            // タッチ/クリックイベント
            const handleInteraction = function (event) {
                event.preventDefault();
                event.stopPropagation();
                // 編集画面へ
                editResponse(response.id);
            };
            card.addEventListener('touchend', handleInteraction, { passive: false });
            card.addEventListener('click', handleInteraction);

            // ヘッダー: アイコン、名前、コメントバッジ
            let commentBadge = '';
            if (response.comment) {
                commentBadge = `
                    <div class="ml-auto">
                        <svg class="w-5 h-5 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                        </svg>
                    </div>
                `;
            }

            const headerHtml = `
                <div class="flex items-center space-x-3 mb-3 border-b border-stone-100 pb-3">
                    <div class="w-10 h-10 bg-stone-600 rounded-full flex items-center justify-center shadow-sm flex-shrink-0">
                        <span class="text-white font-semibold text-sm">${response.participant_name.charAt(0)}</span>
                    </div>
                    <div class="font-semibold text-stone-900 text-lg truncate flex-1">
                        ${response.participant_name}
                    </div>
                    ${commentBadge}
                </div>
            `;

            // ボディ: 日程リスト
            let datesHtml = '<div class="space-y-2">';
            if (currentEvent && currentEvent.candidate_dates) {
                currentEvent.candidate_dates.forEach(dateStr => {
                    const status = getStatusForDate(response, dateStr);
                    let statusIcon = '';
                    let statusColor = '';
                    let statusBg = '';

                    if (status === 'attending') {
                        statusIcon = '○';
                        statusColor = 'text-emerald-600';
                        statusBg = 'bg-emerald-50';
                    } else if (status === 'maybe') {
                        statusIcon = '?';
                        statusColor = 'text-amber-600';
                        statusBg = 'bg-amber-50';
                    } else {
                        statusIcon = '×';
                        statusColor = 'text-gray-400';
                        statusBg = 'bg-gray-50';
                    }

                    const date = new Date(dateStr);
                    const dateLabel = `${date.getMonth() + 1}/${date.getDate()}(${['日', '月', '火', '水', '木', '金', '土'][date.getDay()]}) ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}〜`;

                    datesHtml += `
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-stone-600">${dateLabel}</span>
                            <span class="font-bold ${statusColor} ${statusBg} w-8 h-8 flex items-center justify-center rounded-full text-lg shadow-sm border border-stone-100">${statusIcon}</span>
                        </div>
                     `;
                });
            }
            datesHtml += '</div>';

            // フッター: コメント本文（あれば）
            let footerHtml = '';
            if (response.comment) {
                footerHtml = `
                    <div class="mt-3 pt-3 border-t border-stone-100 text-sm text-stone-600 bg-stone-50 rounded-lg p-3">
                        <span class="font-medium text-xs text-stone-400 block mb-1">コメント</span>
                        ${response.comment}
                    </div>
                `;
            }

            card.innerHTML = headerHtml + datesHtml + footerHtml;
            return card;
        }

        // 指定日時の回答ステータスを取得
        function getStatusForDate(response, dateStr) {
            const targetDate = new Date(dateStr);

            // まず不参加の場合は即座に返す
            if (response.status === 'not_attending') {
                return 'notAttending';
            }

            // available_datesをチェック
            if (response.available_dates && Array.isArray(response.available_dates)) {
                for (const availableDate of response.available_dates) {
                    if (isSameDay(new Date(availableDate), targetDate)) {
                        // 日付が利用可能な場合、ステータスに応じて返す
                        if (response.status === 'attending') {
                            return 'attending';
                        } else if (response.status === 'undecided' || response.status === 'maybe') {
                            return 'maybe';
                        }
                        return 'attending'; // デフォルト
                    }
                }
            }

            // 全体のステータスから未定かどうかを判定
            if (response.status === 'undecided' || response.status === 'maybe') {
                return 'maybe';
            }

            return 'notAttending';
        }

        // ステータスバッジを作成（プロフェッショナルアイコン）
        function createStatusBadge(status) {
            const configs = {
                attending: {
                    icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="9" stroke-width="2.5"/>
                    </svg>`,
                    classes: 'border border-stone-200',
                    style: 'background-color: #F0FDF4; color: #0F7B0F; border-color: #BBF7D0;'
                },
                maybe: {
                    icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01"/>
                    </svg>`,
                    classes: 'border border-stone-200',
                    style: 'background-color: #FFFBEB; color: #D97706; border-color: #FED7AA;'
                },
                notAttending: {
                    icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>`,
                    classes: 'border border-stone-200',
                    style: 'background-color: #F8F9FA; color: #6B7280; border-color: #E5E7EB;'
                }
            };

            const config = configs[status] || configs.notAttending;

            return `
                <span class="status-badge inline-flex items-center justify-center w-8 h-8 rounded-full ${config.classes} border shadow-sm" style="${config.style}">
                    ${config.icon}
                </span>
            `;
        }

        // 日付が同じ日かチェック
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate();
        }

        // 日程別参加状況テーブルを更新
        function updateScheduleTable(responses) {
            if (!currentEvent || !currentEvent.candidate_dates) return;

            // 重複除去を強制実行
            const originalDates = currentEvent.candidate_dates;
            const uniqueDates = [...new Set(originalDates)];

            if (originalDates.length !== uniqueDates.length) {
                console.warn('⚠️ 重複を発見して除去しました');
                currentEvent.candidate_dates = uniqueDates;
            }

            // より確実なセレクター：日程別参加状況セクションのtbodyを取得
            const sections = document.querySelectorAll('section');
            let scheduleTableBody = null;

            sections.forEach(section => {
                const h2 = section.querySelector('h2');
                if (h2 && h2.textContent.includes('日程別回答状況')) {
                    scheduleTableBody = section.querySelector('tbody');
                }
            });

            if (!scheduleTableBody) return;

            scheduleTableBody.innerHTML = '';

            // Mobile List Container
            const mobileScheduleListContainer = document.getElementById('mobile-schedule-list');
            if (mobileScheduleListContainer) {
                mobileScheduleListContainer.innerHTML = '';
            }

            // データがない場合の処理
            if (!responses || responses.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="6" class="py-12 text-center text-stone-500 bg-stone-50/50 rounded-lg border-2 border-dashed border-stone-200">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="w-12 h-12 mb-3 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span class="text-sm font-medium">まだ回答がありません</span>
                    </div>
                 </td>`;
                scheduleTableBody.appendChild(noDataRow);

                if (mobileScheduleListContainer) {
                    mobileScheduleListContainer.innerHTML = `
                        <div class="py-12 text-center text-stone-500 bg-stone-50/50 rounded-xl border-2 border-dashed border-stone-200">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="w-12 h-12 mb-3 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                <span class="text-sm font-medium">まだ回答がありません</span>
                            </div>
                        </div>`;
                }
                return;
            }

            // 各候補日時の統計を計算
            const dateStats = currentEvent.candidate_dates.map((dateStr, index) => {
                const date = new Date(dateStr);
                const stats = {
                    date: date,
                    dateStr: dateStr,
                    attending: 0,
                    maybe: 0,
                    notAttending: 0
                };

                responses.forEach(response => {
                    const tableStatus = getStatusForDate(response, dateStr);
                    if (tableStatus === 'attending') stats.attending++;
                    else if (tableStatus === 'maybe') stats.maybe++;
                    else stats.notAttending++;
                });

                stats.total = stats.attending + stats.maybe + stats.notAttending;
                return stats;
            });

            // 人気順でソート (参加人数降順)
            const sortedStats = [...dateStats].sort((a, b) => b.attending - a.attending);

            // テーブル行とモバイルカードを生成
            sortedStats.forEach((stats, index) => {
                // テーブル行
                const row = createScheduleTableRow(stats, index);
                scheduleTableBody.appendChild(row);

                // モバイルカード
                if (mobileScheduleListContainer) {
                    const card = createScheduleCard(stats, index);
                    mobileScheduleListContainer.appendChild(card);
                }
            });
        }

        // 日程別参加状況テーブルの行を作成
        function createScheduleTableRow(stats, index) {
            const tr = document.createElement('tr');
            tr.className = 'table-row';
            tr.style.borderBottom = '1px solid #E9E5E0';
            tr.style.background = index % 2 === 0 ? '#FFFFFF' : '#FAFAFA';

            // 評価を決定
            let evaluation = {
                icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`,
                text: '検討中',
                color: 'stone'
            };
            if (index === 0 && stats.attending >= 3) {
                evaluation = {
                    icon: `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>`,
                    text: '最有力',
                    color: 'emerald'
                };
            } else if (index <= 1 && stats.attending >= 2) {
                evaluation = {
                    icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                    </svg>`,
                    text: '候補',
                    color: 'amber'
                };
            }

            // 曜日アイコンの色を決定（土日のみ落ち着いた赤色）
            const dayOfWeek = stats.date.getDay();
            const weekdayColor = (dayOfWeek === 0 || dayOfWeek === 6) ? 'red' : 'stone';
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            const weekday = weekdays[stats.date.getDay()];

            tr.innerHTML = `
                <td class="py-4 px-6" style="border-right: 1px solid #E9E5E0;">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-${weekdayColor}-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">${weekday}</span>
                        </div>
                        <div>
                            <div class="text-lg font-semibold text-stone-900">${formatDateLong(stats.date)}</div>
                            <div class="text-sm text-stone-600 flex items-center mt-1">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                ${formatTimeRange(stats.date)}
                            </div>
                        </div>
                    </div>
                </td>
                <td class="py-4 px-4 text-center" style="border-right: 1px solid #E9E5E0;">
                    <div class="flex items-center justify-center space-x-1">
                        <span class="text-lg" style="color: #0F7B0F;">○</span>
                        <span class="text-sm font-medium text-stone-700">${stats.attending}名</span>
                    </div>
                </td>
                <td class="py-4 px-4 text-center" style="border-right: 1px solid #E9E5E0;">
                    <div class="flex items-center justify-center space-x-1">
                        <span class="text-lg" style="color: #D97706;">?</span>
                        <span class="text-sm font-medium text-stone-700">${stats.maybe}名</span>
                    </div>
                </td>
                <td class="py-4 px-4 text-center" style="border-right: 1px solid #E9E5E0;">
                    <div class="flex items-center justify-center space-x-1">
                        <span class="text-lg" style="color: #6B7280;">×</span>
                        <span class="text-sm font-medium text-stone-700">${stats.notAttending}名</span>
                    </div>
                </td>
                <td class="py-4 px-4 text-center" style="border-right: 1px solid #E9E5E0;">
                    <span class="text-sm font-semibold text-stone-900">${stats.total}名</span>
                </td>
                <td class="py-4 px-6 text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-${evaluation.color}-600">${evaluation.icon}</span>
                        <span class="text-sm font-semibold text-${evaluation.color}-600">${evaluation.text}</span>
                    </div>
                </td>
            `;

            return tr;
        }

        // モバイル用スケジュールカードを作成
        function createScheduleCard(stats, index) {
            const date = new Date(stats.date);
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            // UTCベースで日付を取得
            const month = date.getUTCMonth() + 1;
            const day = date.getUTCDate();
            const weekday = weekdays[date.getUTCDay()];
            const dateLabel = `${month}月${day}日(${weekday})`;

            // 時間（UTC->JST変換済みと仮定、またはUTCで処理）
            // ここではDateオブジェクトが既に調整済みと仮定
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const timeLabel = `${hours}:${minutes}〜`;

            // 評価を決定
            let evaluationText = '検討中';
            let evaluationColor = 'text-stone-500';
            let evaluationBg = 'bg-stone-50';

            // 評価ロジック
            if (index === 0 && stats.attending >= 3) {
                evaluationText = '最有力';
                evaluationColor = 'text-emerald-700';
                evaluationBg = 'bg-emerald-50';
            } else if (index <= 1 && stats.attending >= 2) {
                evaluationText = '有力';
                evaluationColor = 'text-emerald-600';
                evaluationBg = 'bg-emerald-50';
            } else if (stats.attending >= 1) {
                evaluationText = '候補';
                evaluationColor = 'text-blue-600';
                evaluationBg = 'bg-blue-50';
            } else {
                evaluationText = '厳しめ';
                evaluationColor = 'text-rose-600';
                evaluationBg = 'bg-rose-50';
            }

            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl border border-stone-200 shadow-sm overflow-hidden mb-4';

            // ヘッダー（日付と評価）
            card.innerHTML = `
                <div class="px-4 py-3 border-b border-stone-100 flex items-center justify-between bg-stone-50">
                    <div class="flex items-center space-x-3">
                         <div class="flex flex-col items-center justify-center w-10 h-10 rounded-lg bg-white border border-stone-200 shadow-sm">
                            <span class="text-xs font-bold text-stone-500">${weekday}</span>
                         </div>
                         <div class="flex flex-col">
                            <span class="text-lg font-bold text-stone-900">${month}月${day}日</span>
                            <span class="text-sm text-stone-500 flex items-center">
                                <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${timeLabel}
                            </span>
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-xs font-bold ${evaluationColor} ${evaluationBg} px-2 py-1 rounded-full border border-stone-100 shadow-sm">${evaluationText}</span>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex items-center justify-between text-center divide-x divide-stone-100">
                        <div class="flex-1 px-1 flex flex-col items-center">
                            <span class="text-xs text-stone-500 mb-1">参加</span>
                            <div class="flex items-baseline space-x-1">
                                <span class="text-emerald-600 font-bold text-lg">○</span>
                                <span class="text-stone-900 font-bold text-xl">${stats.attending}</span>
                                <span class="text-xs text-stone-400">名</span>
                            </div>
                        </div>
                        <div class="flex-1 px-1 flex flex-col items-center">
                            <span class="text-xs text-stone-500 mb-1">未定</span>
                            <div class="flex items-baseline space-x-1">
                                <span class="text-amber-500 font-bold text-lg">?</span>
                                <span class="text-stone-900 font-bold text-xl">${stats.maybe}</span>
                                <span class="text-xs text-stone-400">名</span>
                            </div>
                        </div>
                        <div class="flex-1 px-1 flex flex-col items-center">
                            <span class="text-xs text-stone-500 mb-1">不参加</span>
                            <div class="flex items-baseline space-x-1">
                                <span class="text-gray-400 font-bold text-lg">×</span>
                                <span class="text-stone-900 font-bold text-xl">${stats.notAttending}</span>
                                <span class="text-xs text-stone-400">名</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // 日付フォーマット（長形式）- UTC日付を正確に表示
        function formatDateLong(date) {
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            // UTCベースで日付を取得（タイムゾーン変換の影響を避ける）
            const month = date.getUTCMonth() + 1;
            const day = date.getUTCDate();
            const weekday = weekdays[date.getUTCDay()];
            return `${month}月${day}日（${weekday}）`;
        }

        // 時間フォーマット（開始時間のみ）
        function formatTimeRange(date) {
            // ローカル時間で表示（ブラウザが自動的にタイムゾーン変換）
            const startHour = date.getHours();
            const startMinute = date.getMinutes();
            const startTime = `${startHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`;

            return `${startTime}〜`;
        }

        // 日付フォーマット関数
        function formatDateShort(date) {
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            // UTCベースで日付を取得（タイムゾーン変換の影響を避ける）
            const month = date.getUTCMonth() + 1;
            const day = date.getUTCDate();
            const weekday = weekdays[date.getUTCDay()];
            return `${month}/${day}(${weekday})`;
        }

        function formatTimeShort(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatDateTimeShort(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}`;
        }

        // 回答を編集（グローバルスコープに明示的に配置）
        window.editResponse = function (responseId) {
            console.log('');
            console.log('═══════════════════════════════════════');
            console.log('✏️ editResponse関数が呼び出されました！');
            console.log('═══════════════════════════════════════');
            console.log('📝 編集対象の回答ID:', responseId);
            console.log('📝 回答IDの型:', typeof responseId);
            console.log('📝 イベントID:', currentEventId);
            console.log('📝 イベントIDの型:', typeof currentEventId);
            console.log('📝 window.location.href:', window.location.href);

            // イベントIDの確認
            if (!currentEventId) {
                console.error('❌ イベントIDが設定されていません');
                console.error('❌ currentEventId:', currentEventId);
                showError(
                    new Error('イベントIDが見つかりません'),
                    'currentEventIdが未定義です。ページをリロードしてください。'
                );
                return;
            }

            // 回答IDの確認
            if (!responseId) {
                console.error('❌ 回答IDが設定されていません');
                console.error('❌ responseId:', responseId);
                showError(
                    new Error('回答IDが見つかりません'),
                    'responseIdが未定義です。'
                );
                return;
            }

            // 回答フォームページに遷移（編集モード）
            const urlParams = new URLSearchParams();
            urlParams.set('id', currentEventId);
            urlParams.set('edit', responseId);
            const targetUrl = `response-form.html?${urlParams.toString()}`;
            const fullUrl = window.location.origin + '/' + targetUrl;

            console.log('📱 編集フォームに遷移します:');
            console.log('   - targetUrl:', targetUrl);
            console.log('   - fullUrl:', fullUrl);
            console.log('📋 URLパラメータ:', {
                id: currentEventId,
                edit: responseId
            });

            // 遷移を実行
            console.log('🚀 window.location.hrefを変更します...');
            try {
                window.location.href = targetUrl;
                console.log('✅ 遷移コマンドを実行しました');
                console.log('   ※ 遷移中のため、このログの後は新しいページが読み込まれます');
            } catch (error) {
                console.error('❌ 遷移エラー:', error);
                console.error('❌ エラー詳細:', error.message);
                console.error('❌ エラースタック:', error.stack);
                showError(
                    error,
                    `遷移に失敗しました: ${error.message}`
                );
            }
            console.log('═══════════════════════════════════════');
            console.log('');
        };

        // 後方互換性のためにグローバルスコープにも配置
        const editResponse = window.editResponse;

        // 新規回答フォームに遷移
        function goToResponseForm() {
            console.log('🔄 回答フォームへの遷移を開始');

            // 重複実行を防止（touchendとclickの両方が発火するため）
            if (isNavigating) {
                console.log('⚠️ すでにナビゲーション中です。重複実行を防止します。');
                return;
            }
            isNavigating = true;
            console.log('✅ ナビゲーションフラグをONにしました');

            console.log('- currentEventId:', currentEventId);
            console.log('- currentEvent:', currentEvent);

            if (!currentEventId) {
                console.error('❌ イベントIDが設定されていません');
                isNavigating = false; // フラグをリセット
                alert('エラー: イベント情報が読み込まれていません。ページを再読み込みしてください。');
                return;
            }

            // 回答フォームページに遷移（新規モード）
            const urlParams = new URLSearchParams();
            urlParams.set('id', currentEventId);
            const targetUrl = `response-form.html?${urlParams.toString()}`;
            const fullUrl = window.location.origin + '/' + targetUrl;

            console.log('📱 回答フォームに遷移:', fullUrl);

            // WKWebViewの場合、Swift側にメッセージを送信（履歴が正しく管理される）
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.navigateToUrl) {
                console.log('📱 [iOS App内]: Swiftにページ遷移を依頼します');
                try {
                    window.webkit.messageHandlers.navigateToUrl.postMessage(fullUrl);
                    console.log('✅ Swiftへのメッセージ送信成功');
                    return;
                } catch (e) {
                    console.error('❌ Swiftへのメッセージ送信失敗:', e);
                    // フォールバックとして通常の遷移を試行
                }
            }

            // 通常のブラウザの場合、window.locationで遷移
            console.log('🌐 [通常のブラウザ]: window.location.hrefで遷移');
            window.location.href = fullUrl;
        }

        // イベントURLをコピー
        async function copyEventUrl() {
            const currentUrl = window.location.href;
            const copyBtn = document.getElementById('copyUrlBtn');
            const copyText = document.getElementById('copyText');
            const copyIcon = document.getElementById('copyIcon');

            try {
                await navigator.clipboard.writeText(currentUrl);

                // コピー成功時の視覚的フィードバック
                copyText.textContent = 'コピー完了！';
                copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                copyBtn.classList.remove('bg-kanjy-500', 'hover:bg-kanjy-600');

                // チェックアイコンに変更
                copyIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';

                // 2秒後に元に戻す
                setTimeout(() => {
                    copyText.textContent = 'コピー';
                    copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    copyBtn.classList.add('bg-kanjy-500', 'hover:bg-kanjy-600');
                    copyIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>';
                }, 2000);

            } catch (err) {
                console.error('URLのコピーに失敗しました:', err);
                // フォールバック: テキストを選択状態にする
                const urlElement = document.getElementById('eventUrl');
                urlElement.select(); // input要素を選択

                copyText.textContent = 'URLを選択しました';
                setTimeout(() => {
                    copyText.textContent = 'コピー';
                }, 2000);
            }
        }

        // アニメーション設定
        function setupAnimations() {
            // 改善されたIntersection Observer for animations
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function (entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);

            // Observe all animated elements
            document.querySelectorAll('.animate-slide-up, .animate-fade-in, .animate-scale-in, .fade-in-up').forEach(el => {
                if (!el.classList.contains('visible')) {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(20px)';
                    el.style.transition = 'opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                }
                observer.observe(el);
            });

            // Add interactive hover effects
            document.querySelectorAll('.status-pill').forEach(pill => {
                pill.addEventListener('mouseenter', function () {
                    this.style.transform = 'scale(1.05)';
                });

                pill.addEventListener('mouseleave', function () {
                    this.style.transform = 'scale(1)';
                });
            });

            // Smooth scroll for better UX
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        }

    </script>
</body>

</html>