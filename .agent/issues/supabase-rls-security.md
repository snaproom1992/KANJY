# Supabase RLS Security Issue

## 概要
現在、Supabaseの`events`テーブルのDELETEポリシーが`true`に設定されており、誰でも任意のイベントを削除できる状態になっています。これはセキュリティ上のリスクです。

## 現状
- **DELETE RLSポリシー**: `true`（誰でも削除可能）
- **理由**: `auth.uid()::text = created_by`等の型比較ポリシーが、実装時に動作不良を起こしたため、一時的に`true`に変更

## 問題の根本原因（推測）
1. **データ型の不一致**: `created_by`カラムがtext型だが、`auth.uid()`の返り値との比較で暗黙的な型変換が正しく行われていない可能性
2. **古いデータの影響**: 初期テスト時に"匿名"などの文字列が混入し、UUID型へのキャストでエラーが発生
3. **複数ポリシーの競合**: 削除・再作成を繰り返したことで、古いポリシーが残存している可能性

## 解決策（今後の対応）

### 短期対応
- [ ] データベーススキーマの確認
  - `created_by`カラムの型を確認（text? uuid?）
  - 既存データに不正な値がないか確認

### 中期対応
- [ ] カラム型の統一
  - `created_by`を明示的に`text`型に統一
  - または`uuid`型に統一し、Supabase側で自動キャストが効くことを確認

### 長期対応
- [ ] RLSポリシーの再実装
  - テーブルをクリーンな状態にする
  - 全てのDELETEポリシーを削除
  - 以下のポリシーを1つだけ新規作成:
    ```sql
    created_by = auth.uid()::text
    ```
  - 動作確認後、段階的にセキュアな設定に移行

## 関連ファイル
- `KANJY/AttendanceManagement.swift`: 削除ロジック実装
- `KANJY/SupabaseManager.swift`: 認証管理

## 優先度
**中** - 現状、イベントIDは推測困難なUUIDであり、アプリ経由でしかアクセスできないため、実害は限定的。ただし、本番運用前には必ず対応すべき。

## 作成日
2026-02-01

## ステータス
🔴 未対応
